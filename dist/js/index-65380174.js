Phaser.Sprite.prototype.absorbProperties=function(t){for(var i in t)t.hasOwnProperty(i)&&(this[i]=t[i])};function I(t,i,a){Phaser.Sprite.call(this,game,t,i,a),this.speed=0,this.destination=null,game.add.existing(this)}I.prototype=Object.create(Phaser.Sprite.prototype);I.prototype.constructor=I;window.Being=I;I.prototype.setAnimations=function(t){var i=this.frames||this.defaultFrames,a;t==this.weapon?(i=this.defaultFrames,a=this.weapon.name):a=t instanceof Monster?this.monsterName:this.armorName;var s={"":8,idle_:i.hasOwnProperty("idle_rate")?i.idle_rate:2,attack_:14},n;i.hasOwnProperty("death")?n=Phaser.Animation.generateFrameNames(a+"_",i.death[0],i.death[1]):n=Phaser.Animation.generateFrameNames("death_",0,5),t.animations.add("death",n,8,!1);for(var r=["","idle_","attack_"],c=["down","up","left","right"],h=0;h<r.length;h++)for(var y=0;y<c.length;y++){var g=r[h]+c[y];if(i.hasOwnProperty(g)){var w=Phaser.Animation.generateFrameNames(a+"_",i[g][0],i[g][1]);i[g][2]&&w.push(a+"_"+i[g][2]),t.animations.add(g,w,s[r[h]],r[h]!="attack_")}}};I.prototype.idle=function(t){this.animate("idle_"+orientationsDict[this.orientation],t)};I.prototype.attackAndDisplay=function(t){this.target&&(this.attack(),this.target.displayHP(t))};I.prototype.attack=function(){if(this.target){var t=Game.adjacent(this,this.target);if(t>0&&(this.orientation=t),this.animate("attack_"+orientationsDict[this.orientation],!1),this.inCamera){var i=this instanceof Player?"hit1":"hurt";Game.sounds.play(i)}this.target.deathmark&&setTimeout(function(a){a.die(!0)},500,this.target),this.idle()}};I.prototype.flagForDeath=function(){this.deathmark=!0};I.prototype.displayHP=function(t){var i=this.isPlayer?t>=0?"heal":"hurt":"hit";Game.displayHP(t,i,this,Game.HPdelay),this.isPlayer&&t>0&&Game.sounds.play("heal")};I.prototype.endFight=function(){this.fightTween&&this.fightTween.stop(),this.fightTween=null,this.inFight=!1,this.deathmark=!1,this.idle(!1)};I.prototype.adjustStartPosition=function(t){switch(this.orientation){case 3:this.x%32!=0&&t.x++;break;case 4:this.y%32!=0&&t.y++;break}return t};I.prototype.pathfindingCallback=function(t,i,a,s,n){if(n===null&&this.isPlayer)Game.moveTarget.visible=!1,Game.marker.visible=!0;else if(n!==null){(i.action==3||i.action==4)&&(t=Game.computeFinalOrientation(n),n.pop());var r=i.action!=1?i:{action:0};this.isPlayer&&s&&n.length&&Client.sendPath(n,r,t),this.move(n,t,i,a)}};I.prototype.move=function(t,i,a,s){if(!t.length){this.finishMovement(i,a);return}for(var n=[],r=[],c=0;c<t.length;c++)n.push(t[c].x*Game.map.tileWidth),r.push(t[c].y*Game.map.tileWidth);var h=game.add.tween(this);this.lastOrientationCheck=0;var y=Math.ceil(Math.max(1,t.length*this.speed-s));h.to({x:n,y:r},y);var g=this instanceof Player?.7:.4;h.onUpdateCallback(function(){Date.now()-this.lastOrientationCheck<this.speed*g||(this.lastOrientationCheck=Date.now(),this.position.x>this.previousPosition.x?this.orient(3):this.position.x<this.previousPosition.x?this.orient(1):this.position.y>this.previousPosition.y?this.orient(4):this.position.y<this.previousPosition.y&&this.orient(2),this.animate(orientationsDict[this.orientation],!1))},this),h.onComplete.add(function(){this.finishMovement(i,a)},this),this.tween=h,h.start()};I.prototype.orient=function(t){this.orientation!=t&&(this.orientation=t)};I.prototype.stopMovement=function(t){this.tween.stop(t),this.tween=null};I.prototype.setPosition=function(t,i){this.x=t*Game.map.tileWidth,this.y=i*Game.map.tileHeight};function te(t){let i;try{i=new URL(t)}catch{return!1}return i.protocol==="http:"||i.protocol==="https:"}I.prototype.finishMovement=async function(t,i){if(this.isPlayer){if(i.action==1){const s=await fetch("http://localhost:8081/game-test",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:"Quest1",params:[]})});console.log(s),te(i.text)?i.character.displayBubble(i.text,i.text):i.character.displayBubble(i.text),Game.speakAchievement||Game.handleSpeakAchievement()}Game.moveTarget.visible=!1,Game.handleLocationAchievements()}if(this instanceof Player){var a=Game.detectElement(Game.doors,this.x,this.y);a&&(t=this.teleport(a))}t&&this.orient(t),this.tween=null,this.idle(!1),Game.sortEntities()};I.prototype.hasMoved=function(){return this.position.x!=this.previousPosition.x||this.position.y!=this.previousPosition.y};I.prototype.animate=function(t,i){if(t=="death"||i){this.animations.stop(),this.animations.play(t),this.weapon&&this.weapon.animations.play(t);return}var a=this.animations.currentAnim;a.name!="death"&&(a.isPlaying&&!a.loop?a.name!=t&&a.onComplete.addOnce(function(){this.animate(t,!1)},this):(this.animations.play(t),this.weapon&&this.weapon.animations.play(t)))};I.prototype.delayedDeath=function(t){setTimeout(function(i){i.die(!0)},t,this)};I.prototype.delayedKill=function(t){setTimeout(function(i){i.kill()},t,this)};var f={eventsQueue:[],initEventName:"init",storageNameKey:"playerName",storageIDKey:"playerID"};window.Client=f;f.socket=io.connect("http://localhost:8081");var Z=f.socket.onevent;f.socket.onevent=function(t){!Game.playerIsInitialized&&t.data[0]!=f.initEventName&&t.data[0]!="dbError"?f.eventsQueue.push(t):Z.call(this,t)};f.emptyQueue=function(){for(var t=0;t<f.eventsQueue.length;t++)Z.call(f.socket,f.eventsQueue[t])};f.requestData=function(){f.socket.emit("init-world",f.getInitRequest())};f.getInitRequest=function(){if(f.isNewPlayer())return{new:!0,name:f.getName(),clientTime:Date.now()};var t=f.getPlayerID();return{new:!1,id:t,clientTime:Date.now()}};f.isNewPlayer=function(){var t=f.getPlayerID(),i=f.getName(),a=f.getArmor(),s=f.getWeapon();return!(t!==void 0&&i&&a&&s)};f.setLocalData=function(t){localStorage.setItem(f.storageIDKey,t)};f.getPlayerID=function(){return localStorage.getItem(f.storageIDKey)};f.hasAchievement=function(t){return!!localStorage.getItem("ach"+t)};f.setAchievement=function(t){localStorage.setItem("ach"+t,!0)};f.setArmor=function(t){localStorage.setItem("armor",t)};f.getArmor=function(){return localStorage.getItem("armor")};f.setWeapon=function(t){localStorage.setItem("weapon",t)};f.getWeapon=function(){return localStorage.getItem("weapon")};f.setName=function(t){localStorage.setItem("name",t)};f.setCurrentQuest=function(t){localStorage.setItem("currentQuest",t)};f.getName=function(){return localStorage.getItem("name")};f.getCurrentQuest=function(){return localStorage.getItem("currentQuest")};f.socket.on("pid",function(t){f.setLocalData(t)});f.socket.on(f.initEventName,function(t){t instanceof ArrayBuffer&&(t=Decoder.decode(t,CoDec.initializationSchema)),f.socket.emit("ponq",t.stamp),Game.initWorld(t),Game.updateNbConnected(t.nbconnected)});f.socket.on("update",function(t){t instanceof ArrayBuffer&&(t=Decoder.decode(t,CoDec.finalUpdateSchema)),f.socket.emit("ponq",t.stamp),t.nbconnected!==void 0&&Game.updateNbConnected(t.nbconnected),t.latency&&Game.setLatency(t.latency),t.global&&Game.updateWorld(t.global),t.local&&Game.updateSelf(t.local)});f.socket.on("reset",function(t){Game.moveCharacter(Game.player.id,t,0,Game.latency)});f.socket.on("dbError",function(){localStorage.clear(),Game.displayError()});f.socket.on("wait",function(){console.log("Server not ready, re-attempting..."),setTimeout(f.requestData,500)});f.socket.on("chat",function(t){Game.playerSays(t.id,t.txt)});f.socket.on("check-done",function(t){console.log(t)});f.sendPath=function(t,i,a){f.socket.emit("path",{path:t,action:i,or:a})};f.sendChat=function(t){!t.length||t.length>Game.maxChatLength||f.socket.emit("chat",t)};f.sendCheck=function(t){t!==""&&(console.log("Sendcheck: ",t),f.socket.emit("check-quest",t))};f.sendRevive=function(){f.socket.emit("revive")};f.deletePlayer=function(){f.socket.emit("delete",{id:f.getPlayerID()}),localStorage.clear()};var F={};F.decode=function(t,i){var a=F.decodeObject(t,0,i);return a.object};window.Decoder=F;F.countFields=function(t){var i=0;return t.numerical!==void 0&&(i+=Object.keys(t.numerical).length),t.arrays!==void 0&&(i+=Object.keys(t.arrays).length),t.maps!==void 0&&(i+=Object.keys(t.maps).length),t.standAlone!==void 0&&(i+=Object.keys(t.standAlone).length),t.strings!==void 0&&(i+=t.strings.length),t.booleans!==void 0&&(i+=t.booleans.length),i};F.decodeObject=function(t,i,a){var s=new DataView(t),n={},r=F.countFields(a),c=s["getUint"+a.propertiesBytes*8](i);i+=a.propertiesBytes;var h=1;if(a.numerical&&Object.keys(a.numerical).forEach(function(w){if(F.isMaskTrue(c,r,h)){var b=a.numerical[w];n[w]=s["getUint"+b*8](i),i+=b}h++}),a.strings&&a.strings.forEach(function(w){if(F.isMaskTrue(c,r,h)){var b=s.getUint8(i);i++,n[w]=F.decodeString(s,b,i),i+=b*CoDec.bytesPerChar}h++}),a.arrays&&Object.keys(a.arrays).forEach(function(w){if(F.isMaskTrue(c,r,h)){var b=s.getUint8(i);if(i++,b){n[w]=[];for(var D=a.arrays[w],H=0;H<b;H++){var G;if(D.primitive)D.type=="int"&&(G=s["getUint"+D.bytes*8](i),i+=D.bytes);else{var L=F.decodeObject(t,i,D);G=L.object,i=L.offset}n[w].push(G)}}}h++}),a.maps&&Object.keys(a.maps).forEach(function(w){if(F.isMaskTrue(c,r,h)){var b=s.getUint8(i);if(i++,b){n[w]={};for(var D=0;D<b;D++){var H=s["getUint"+CoDec.bytesPerID*8](i);i+=CoDec.bytesPerID;var G=F.decodeObject(t,i,a.maps[w]);n[w][H]=G.object,i=G.offset}}}h++}),a.standAlone&&Object.keys(a.standAlone).forEach(function(w){if(F.isMaskTrue(c,r,h)){var b=F.decodeObject(t,i,a.standAlone[w]);n[w]=b.object,i=b.offset}h++}),a.booleans){var y=s["getUint"+CoDec.booleanBytes*8](i),g=1;i+=CoDec.booleanBytes,a.booleans.forEach(function(w){F.isMaskTrue(c,r,h)&&(n[w]=!!F.isMaskTrue(y,a.booleans.length,g)),h++,g++})}return{object:n,offset:i}};F.isMaskTrue=function(t,i,a){return t>>i-a&1};F.decodeString=function(t,i,a){for(var s=[],n=0;n<i;n++)s.push(String.fromCharCode(t["getUint"+CoDec.bytesPerChar*8](a))),a+=CoDec.bytesPerChar;return s.join("")};var ie=function(t){function i(s){if(a[s])return a[s].exports;var n=a[s]={exports:{},id:s,loaded:!1};return t[s].call(n.exports,n,n.exports,i),n.loaded=!0,n.exports}var a={};return i.m=t,i.c=a,i.p="",i(0)}([function(t,i,a){var s={},n=a(1),r=a(2),c=a(3);const h=0,y=1;t.exports=s,s.js=function(){var g,w,b,D=1,H=1.4,G=!1,L={},z={},Y={},W=!0,A=[],j=Number.MAX_VALUE,d=!1;this.setAcceptableTiles=function(o){o instanceof Array?b=o:!isNaN(parseFloat(o))&&isFinite(o)&&(b=[o])},this.enableSync=function(){G=!0},this.disableSync=function(){G=!1},this.enableDiagonals=function(){d=!0},this.disableDiagonals=function(){d=!1},this.setGrid=function(o){g=o;for(var m=0;m<g.length;m++)for(var x=0;x<g[0].length;x++)z[g[m][x]]||(z[g[m][x]]=1)},this.setTileCost=function(o,m){z[o]=m},this.setAdditionalPointCost=function(o,m,x){Y[o+"_"+m]=x},this.removeAdditionalPointCost=function(o,m){delete Y[o+"_"+m]},this.removeAllAdditionalPointCosts=function(){Y={}},this.setIterationsPerCalculation=function(o){j=o},this.avoidAdditionalPoint=function(o,m){L[o+"_"+m]=1},this.stopAvoidingAdditionalPoint=function(o,m){delete L[o+"_"+m]},this.enableCornerCutting=function(){W=!0},this.disableCornerCutting=function(){W=!1},this.stopAvoidingAllAdditionalPoints=function(){L={}},this.findPath=function(o,m,x,P,S){var C=function(q){G?S(q):setTimeout(function(){S(q)})};if(b===void 0)throw new Error("You can't set a path without first calling setAcceptableTiles() on EasyStar.");if(g===void 0)throw new Error("You can't set a path without first calling setGrid() on EasyStar.");if(0>o||0>m||0>x||0>P||o>g[0].length-1||m>g.length-1||x>g[0].length-1||P>g.length-1)throw new Error("Your start or end point is outside the scope of your grid.");if(o===x&&m===P)return void C([]);for(var M=g[P][x],O=!1,Q=0;Q<b.length;Q++)if(M===b[Q]){O=!0;break}if(O===!1)return void C(null);var E=new n;E.openList=new c(function(q,ee){return q.bestGuessDistance()-ee.bestGuessDistance()}),E.isDoneCalculating=!1,E.nodeHash={},E.startX=o,E.startY=m,E.endX=x,E.endY=P,E.callback=C,E.openList.push(T(E,E.startX,E.startY,null,D)),A.push(E)},this.calculate=function(){if(A.length!==0&&g!==void 0&&b!==void 0)for(w=0;j>w;w++){if(A.length===0)return;if(G&&(w=0),A[0].openList.size()!==0){var o=A[0].openList.pop();if(A[0].endX===o.x&&A[0].endY===o.y){A[0].isDoneCalculating=!0;var m=[];m.push({x:o.x,y:o.y});for(var x=o.parent;x!=null;)m.push({x:x.x,y:x.y}),x=x.parent;m.reverse();var P=A[0],S=m;return void P.callback(S)}var C=[];o.list=h,o.y>0&&C.push({instance:A[0],searchNode:o,x:0,y:-1,cost:D*v(o.x,o.y-1)}),o.x<g[0].length-1&&C.push({instance:A[0],searchNode:o,x:1,y:0,cost:D*v(o.x+1,o.y)}),o.y<g.length-1&&C.push({instance:A[0],searchNode:o,x:0,y:1,cost:D*v(o.x,o.y+1)}),o.x>0&&C.push({instance:A[0],searchNode:o,x:-1,y:0,cost:D*v(o.x-1,o.y)}),d&&(o.x>0&&o.y>0&&(W||u(g,b,o.x,o.y-1)&&u(g,b,o.x-1,o.y))&&C.push({instance:A[0],searchNode:o,x:-1,y:-1,cost:H*v(o.x-1,o.y-1)}),o.x<g[0].length-1&&o.y<g.length-1&&(W||u(g,b,o.x,o.y+1)&&u(g,b,o.x+1,o.y))&&C.push({instance:A[0],searchNode:o,x:1,y:1,cost:H*v(o.x+1,o.y+1)}),o.x<g[0].length-1&&o.y>0&&(W||u(g,b,o.x,o.y-1)&&u(g,b,o.x+1,o.y))&&C.push({instance:A[0],searchNode:o,x:1,y:-1,cost:H*v(o.x+1,o.y-1)}),o.x>0&&o.y<g.length-1&&(W||u(g,b,o.x,o.y+1)&&u(g,b,o.x-1,o.y))&&C.push({instance:A[0],searchNode:o,x:-1,y:1,cost:H*v(o.x-1,o.y+1)}));for(var M=!1,O=0;O<C.length;O++)if(p(C[O].instance,C[O].searchNode,C[O].x,C[O].y,C[O].cost),C[O].instance.isDoneCalculating===!0){M=!0;break}M&&A.shift()}else{var P=A[0];P.callback(null),A.shift()}}};var p=function(o,m,x,P,S){var C=m.x+x,M=m.y+P;if(L[C+"_"+M]===void 0&&u(g,b,C,M)){var O=T(o,C,M,m,S);O.list===void 0?(O.list=y,o.openList.push(O)):m.costSoFar+S<O.costSoFar&&(O.costSoFar=m.costSoFar+S,O.parent=m,o.openList.updateItem(O))}},u=function(o,m,x,P){for(var S=0;S<m.length;S++)if(o[P][x]===m[S])return!0;return!1},v=function(o,m){return Y[o+"_"+m]||z[g[m][o]]},T=function(o,m,x,P,S){if(o.nodeHash[m+"_"+x]!==void 0)return o.nodeHash[m+"_"+x];var C=k(m,x,o.endX,o.endY);if(P!==null)var M=P.costSoFar+S;else M=0;var O=new r(P,m,x,M,C);return o.nodeHash[m+"_"+x]=O,O},k=function(o,m,x,P){if(d){var S=Math.abs(o-x),C=Math.abs(m-P);return C>S?H*S+C:H*C+S}var S=Math.abs(o-x),C=Math.abs(m-P);return S+C}}},function(t,i){t.exports=function(){this.isDoneCalculating=!0,this.pointsToAvoid={},this.startX,this.callback,this.startY,this.endX,this.endY,this.nodeHash={},this.openList}},function(t,i){t.exports=function(a,s,n,r,c){this.parent=a,this.x=s,this.y=n,this.costSoFar=r,this.simpleDistanceToTarget=c,this.bestGuessDistance=function(){return this.costSoFar+this.simpleDistanceToTarget}}},function(t,i,a){t.exports=a(4)},function(t,i,a){var s,n,r;(function(){var c,h,y,g,w,b,D,H,G,L,z,Y,W,A,j;y=Math.floor,L=Math.min,h=function(d,p){return p>d?-1:d>p?1:0},G=function(d,p,u,v,T){var k;if(u==null&&(u=0),T==null&&(T=h),0>u)throw new Error("lo must be non-negative");for(v==null&&(v=d.length);v>u;)k=y((u+v)/2),T(p,d[k])<0?v=k:u=k+1;return[].splice.apply(d,[u,u-u].concat(p)),p},b=function(d,p,u){return u==null&&(u=h),d.push(p),A(d,0,d.length-1,u)},w=function(d,p){var u,v;return p==null&&(p=h),u=d.pop(),d.length?(v=d[0],d[0]=u,j(d,0,p)):v=u,v},H=function(d,p,u){var v;return u==null&&(u=h),v=d[0],d[0]=p,j(d,0,u),v},D=function(d,p,u){var v;return u==null&&(u=h),d.length&&u(d[0],p)<0&&(v=[d[0],p],p=v[0],d[0]=v[1],j(d,0,u)),p},g=function(d,p){var u,v,T,k,o,m;for(p==null&&(p=h),k=function(){m=[];for(var x=0,P=y(d.length/2);P>=0?P>x:x>P;P>=0?x++:x--)m.push(x);return m}.apply(this).reverse(),o=[],v=0,T=k.length;T>v;v++)u=k[v],o.push(j(d,u,p));return o},W=function(d,p,u){var v;return u==null&&(u=h),v=d.indexOf(p),v!==-1?(A(d,0,v,u),j(d,v,u)):void 0},z=function(d,p,u){var v,T,k,o,m;if(u==null&&(u=h),T=d.slice(0,p),!T.length)return T;for(g(T,u),m=d.slice(p),k=0,o=m.length;o>k;k++)v=m[k],D(T,v,u);return T.sort(u).reverse()},Y=function(d,p,u){var v,T,k,o,m,x,P,S,C;if(u==null&&(u=h),10*p<=d.length){if(k=d.slice(0,p).sort(u),!k.length)return k;for(T=k[k.length-1],P=d.slice(p),o=0,x=P.length;x>o;o++)v=P[o],u(v,T)<0&&(G(k,v,0,null,u),k.pop(),T=k[k.length-1]);return k}for(g(d,u),C=[],m=0,S=L(p,d.length);S>=0?S>m:m>S;S>=0?++m:--m)C.push(w(d,u));return C},A=function(d,p,u,v){var T,k,o;for(v==null&&(v=h),T=d[u];u>p&&(o=u-1>>1,k=d[o],v(T,k)<0);)d[u]=k,u=o;return d[u]=T},j=function(d,p,u){var v,T,k,o,m;for(u==null&&(u=h),T=d.length,m=p,k=d[p],v=2*p+1;T>v;)o=v+1,T>o&&!(u(d[v],d[o])<0)&&(v=o),d[p]=d[v],p=v,v=2*p+1;return d[p]=k,A(d,m,p,u)},c=function(){function d(p){this.cmp=p??h,this.nodes=[]}return d.push=b,d.pop=w,d.replace=H,d.pushpop=D,d.heapify=g,d.updateItem=W,d.nlargest=z,d.nsmallest=Y,d.prototype.push=function(p){return b(this.nodes,p,this.cmp)},d.prototype.pop=function(){return w(this.nodes,this.cmp)},d.prototype.peek=function(){return this.nodes[0]},d.prototype.contains=function(p){return this.nodes.indexOf(p)!==-1},d.prototype.replace=function(p){return H(this.nodes,p,this.cmp)},d.prototype.pushpop=function(p){return D(this.nodes,p,this.cmp)},d.prototype.heapify=function(){return g(this.nodes,this.cmp)},d.prototype.updateItem=function(p){return W(this.nodes,p,this.cmp)},d.prototype.clear=function(){return this.nodes=[]},d.prototype.empty=function(){return this.nodes.length===0},d.prototype.size=function(){return this.nodes.length},d.prototype.clone=function(){var p;return p=new d,p.nodes=this.nodes.slice(0),p},d.prototype.toArray=function(){return this.nodes.slice(0)},d.prototype.insert=d.prototype.push,d.prototype.top=d.prototype.peek,d.prototype.front=d.prototype.peek,d.prototype.has=d.prototype.contains,d.prototype.copy=d.prototype.clone,d}(),function(d,p){return n=[],s=p,r=typeof s=="function"?s.apply(i,n):s,!(r!==void 0&&(t.exports=r))}(this,function(){return c})}).call(this)}]);window.EasyStar=ie;function V(t){this.graveyard=[],this.create=t}window.Factory=V;V.prototype.next=function(t,i,a){for(var s=0;s<this.graveyard.length;s++)if(!this.graveyard[s].alive)return this.setUp(this.graveyard[s],t,i,a);return this.create(t,i,a)};V.prototype.setUp=function(t,i,a,s){return t.x=i,t.y=a,t.revive(),t};var e={borderPadding:10,HUDheight:32,achievementsHolderWidth:850,barY:0,nbGroundLayers:4,defaultOrientation:4,playerSpeed:120,playerLife:100,cursor:"url(/assets/sprites/hand.png), auto",talkCursor:"url(/assets/sprites/talk.png), auto",lootCursor:"url(/assets/sprites/loot.png), auto",fightCursor:"url(/assets/sprites/sword.png), auto",markerPosition:new Phaser.Point,previousMarkerPosition:new Phaser.Point,cameraFollowing:!0,mapWideningY:54,speechBubbleCornerSize:5,healthBarWidth:179,nbConnected:0,playerIsInitialized:!1,inDoor:!1,HPdelay:100,maxChatLength:300,latency:0,charactersPool:{},clickDelay:Phaser.Timer.SECOND*.2,clickEnabled:!0};window.Game=e;var ae={1:"left",2:"up",3:"right",4:"down"};window.orientationsDict=ae;e.init=function(){e.easystar=new EasyStar.js,game.canvas.style.cursor=e.cursor};e.preload=function(){game.load.tilemap("map","assets/maps/minimap_client.json",null,Phaser.Tilemap.TILED_JSON),game.load.spritesheet("tileset","assets/tilesets/tilesheet.png",32,32),game.load.atlasJSONHash("atlas4","assets/sprites/atlas4.png","assets/sprites/atlas4.json"),game.load.spritesheet("bubble","assets/sprites/bubble2.png",5,5),game.load.spritesheet("life","assets/sprites/lifelvl.png",5,18),game.load.audio("sounds","assets/audio/sounds.mp3","assets/audio/sounds.ogg"),game.load.json("entities","assets/json/entities_client.json")};e.makeIDmap=function(t,i){Object.keys(t).forEach(function(a){var s=t[a];i[s.id]=a})};e.create=function(){e.HUD=game.add.group(),e.HUD.add(game.add.sprite(0,0,"atlas1","border")),e.displayLoadingScreen(),e.itemsInfo=e.db.items,e.npcInfo=e.db.npc,e.monstersInfo=e.db.monsters,e.findLocationAchievements(),e.itemsIDmap={},e.monstersIDmap={},e.makeIDmap(e.itemsInfo,e.itemsIDmap),e.makeIDmap(e.monstersInfo,e.monstersIDmap),e.entities=game.add.group(),e.scenery=game.add.group(),e.displayMap(),e.displayNPC(),e.createMarker(),e.makeHPtexts(),e.addSounds(),e.playerFactory=new Factory(function(t,i,a){return new Player(t,i,a)}),e.itemFactory=new Factory(function(t,i,a){return new Item(t,i,a)}),e.monsterFactory=new Factory(function(t,i,a){return new Monster(t,i,a)}),Client.requestData()};e.updateWorld=function(t){var i=[];if(t.newplayers){for(var a=0;a<t.newplayers.length;a++)e.createPlayer(t.newplayers[a]),i.push(t.newplayers[a].id);t.newplayers.length>0&&e.sortEntities()}t.newitems&&e.populateTable(e.itemsTable,t.newitems,e.createItem),t.newmonsters&&(e.populateTable(e.monstersTable,t.newmonsters,e.createMonster),e.sortEntities());for(var a=0;a<i.length;a++){var s=e.charactersPool[i[a]];s.inFight&&(s.target=e.monstersTable[s.targetID],s.fight())}if(t.disconnected)for(var n=0;n<t.disconnected.length;n++)e.removePlayer(e.charactersPool[t.disconnected[n]],!0);t.items&&e.traverseUpdateObject(t.items,e.itemsTable,e.updateItem),t.players&&e.traverseUpdateObject(t.players,e.charactersPool,e.updatePlayerStatus),t.monsters&&e.traverseUpdateObject(t.monsters,e.monstersTable,e.updateMonsterStatus),t.players&&e.traverseUpdateObject(t.players,e.charactersPool,e.updatePlayerAction),t.monsters&&e.traverseUpdateObject(t.monsters,e.monstersTable,e.updateMonsterAction)};e.populateTable=function(t,i,a){for(var s=0;s<i.length;s++){var n=i[s],r=a(n);r.id=n.id,t[n.id]=r}};e.traverseUpdateObject=function(t,i,a){Object.keys(t).forEach(function(s){i[s]&&a(i[s],t[s])})};e.createMonster=function(t){var i=e.monstersTable[t.id]?e.monstersTable[t.id]:e.monsterFactory.next(t.x*e.map.tileWidth,t.y*e.map.tileHeight,"atlas4");return i.setUp(e.monstersIDmap[t.monster]),e.updateMonsterStatus(i,t),e.updateMonsterAction(i,t),i};e.createItem=function(t){var i;return e.itemsTable[t.id]?i=e.itemsTable[t.id]:(i=e.itemFactory.next(t.x*e.map.tileWidth,t.y*e.map.tileHeight,"atlas3"),i.setUp(e.itemsIDmap[t.itemID],t.chest,t.inChest,t.visible,t.respawn,t.loot)),e.updateItem(i,t),i};e.createPlayer=function(t){var i;e.charactersPool[t.id]?i=e.charactersPool[t.id]:i=e.newPlayer(t.x,t.y,t.id),t.alive||(i.visible=!1),e.setUpPlayer(i,t),e.updatePlayerStatus(i,t),e.updatePlayerAction(i,t),e.displayedPlayers.add(i.id)};e.newPlayer=function(t,i,a){var s=e.playerFactory.next(t*e.map.tileWidth,i*e.map.tileHeight,"atlas3");return s.orientation=e.defaultOrientation,s.id=a,e.entities.add(s),e.charactersPool[a]=s,e.sortEntities(),s};e.setUpPlayer=function(t,i){t.setName(i.name),t.speed=e.playerSpeed,t.orientation=e.defaultOrientation};e.fadeInTween=function(t){t.alpha=0;var i=game.add.tween(t);i.to({alpha:1},Phaser.Timer.SECOND/2),i.start()};e.updatePlayerStatus=function(t,i){if(i.connected==!1){e.removePlayer(t,!0);return}i.x&&i.y&&t.position.set(i.x*e.map.tileWidth,i.y*e.map.tileHeight),i.aoi&&(t.aoi=i.aoi,t.isPlayer&&e.updateDisplayList()),i.alive==!1&&t.alive==!0&&t.flagForDeath(),i.weapon&&e.updateEquipment(t,i.weapon),i.armor&&e.updateEquipment(t,i.armor),(i.weapon||i.armor)&&t.idle(!1),i.targetID!==void 0&&(t.target=i.targetID?e.monstersTable[i.targetID]:null)};e.updateDisplayList=function(){if(e.displayedPlayers){var t=AOIutils.listAdjacentAOIs(e.player.aoi);e.displayedPlayers.forEach(function(i){var a=e.charactersPool[i];a&&t.indexOf(a.aoi)==-1&&e.removePlayer(a,!1)})}};e.updateEquipment=function(t,i){var a=e.itemsIDmap[i],s=e.itemsInfo[a];s.type==1?t.equipWeapon(a):s.type==2&&t.equipArmor(a)};e.updatePlayerAction=function(t,i){if(i.alive==!0&&t.alive==!1&&t.respawn(),!!t.alive){if(i.alive==!1&&t.alive==!0){if(!t.isPlayer){var a=e.monstersTable[i.lastHitter];a&&a.attack(),t.delayedDeath(500)}return}!t.isPlayer&&i.route&&e.moveCharacter(t.id,i.route.end,i.route.orientation,i.route.delta),i.inFight==!1&&t.inFight==!0?t.endFight():i.inFight==!0&&t.inFight==!1&&t.fight()}};e.updateMonsterStatus=function(t,i){if(i.alive==!1&&t.alive==!0){t.flagForDeath(),t.delayedDeath(500);return}i.x&&i.y&&t.position.set(i.x*e.map.tileWidth,i.y*e.map.tileHeight),i.targetID!==void 0&&(t.target=e.charactersPool[i.targetID])};e.updateMonsterAction=function(t,i){if(i.alive==!1&&t.alive==!0){var a=e.charactersPool[i.lastHitter];a&&a.attack();return}else i.alive==!0&&t.alive==!1&&t.respawn();i.route&&e.moveMonster(t.id,i.route.path,i.route.delta),i.inFight==!1&&t.inFight==!0?t.endFight():i.inFight==!0&&t.inFight==!1&&t.fight()};e.updateItem=function(t,i){i.visible==!1&&t.alive==!0?t.remove():i.visible==!0&&t.alive==!1&&t.respawn(),i.inChest==!1&&t.inChest==!0&&t.open()};e.updateSelf=function(t){if(t.life!==void 0&&(e.player.life=t.life,e.player.updateLife()),t.x!=null&&t.y!=null&&(e.player.alive||e.player.respawn(),e.player.position.set(t.x*e.map.tileWidth,t.y*e.map.tileHeight),e.followPlayer()),t.hp!==void 0)for(var i=0;i<t.hp.length;i++){var a=t.hp[i];if(a.target==!1)if(a.from!==void 0){var s=e.monstersTable[a.from];s.attackAndDisplay(-a.hp)}else e.player.displayHP(a.hp,0);else a.target==!0&&e.player.attackAndDisplay(-a.hp)}if(t.killed)for(var n=0;n<t.killed.length;n++){var r=e.monstersInfo[e.monstersIDmap[t.killed[n]]].name;e.messageIn("You killed a "+r+"!"),e.handleKillAchievement(t.killed[n])}if(t.used)for(var n=0;n<t.used.length;n++){var c=e.itemsInfo[e.itemsIDmap[t.used[n]]];c.msg&&e.messageIn(c.msg),(!e.weaponAchievement||!e.armorAchievement)&&e.handleLootAchievement(t.used[n])}t.noPick&&(e.messageIn("You already have better equipment!"),e.sounds.play("noloot"))};e.revivePlayer=function(){Client.sendRevive(),e.deathScroll.hideTween.start()};e.setLatency=function(t){e.latency=t};e.initWorld=function(t){AOIutils.nbAOIhorizontal=t.nbAOIhorizontal,AOIutils.lastAOIid=t.lastAOIid,e.displayHero(t.player.x,t.player.y,t.player.id),e.displayHUD(),e.setUpPlayer(e.player,t.player),e.updatePlayerStatus(e.player,t.player),e.moveGroupTo(game.world,e.groundMapLayers,0),e.moveGroupTo(game.world,e.scenery,e.groundMapLayers.z),e.moveGroupTo(game.world,e.markerGroup,e.scenery.z),e.moveGroupTo(game.world,e.entities,e.markerGroup.z),e.moveGroupTo(game.world,e.highMapLayers,e.entities.z),e.moveGroupTo(game.world,e.HUD,e.highMapLayers.z),e.itemsTable={},e.monstersTable={},e.displayedPlayers=new Set,e.playerIsInitialized=!0,document.hasFocus()?game.stage.disableVisibilityChange=!0:game.onResume.addOnce(function(){game.stage.disableVisibilityChange=!0},this),e.weaponAchievement=Client.hasAchievement(0),e.armorAchievement=Client.hasAchievement(4),e.speakAchievement=Client.hasAchievement(3),Client.emptyQueue(),e.groundMapLayers.setAll("visible",!0),e.highMapLayers.setAll("visible",!0),e.loadingShade.destroy(),e.loadingText.destroy(),e.messageIn(e.isNewPlayer?"Welcome to PhaserQuest!":"Welcome back!"),e.isNewPlayer&&e.toggleHelp()};e.moveGroupTo=function(t,i,a){var s=i.z-1,n=s-a;if(n>0)for(n;n>0;n--)t.moveDown(i);else if(n<0)for(n;n<0;n++)t.moveUp(i)};e.displayHero=function(t,i,a){e.player=e.newPlayer(t,i,a),e.player.setIsPlayer(!0),e.player.addChild(e.cameraFocus=game.add.sprite(0,16)),e.followPlayer()};e.moveCharacter=function(t,i,a,s){var n=e.charactersPool[t];n.prepareMovement(i,a,{action:0},s+e.latency,!1)};e.moveMonster=function(t,i,a){var s=e.monstersTable[t];s&&s.prepareMovement(i,{action:0},a+e.latency)};e.removePlayer=function(t,i){t&&(t.die(i),delete e.charactersPool[t.id])};e.makeAchievementsScroll=function(){var t=e.db.achievements;e.nbAchievements=Object.keys(t).length;var i=4;e.currentAchievementsPage=1,e.minAchievementsPage=1,e.maxAchievementsPage=e.nbAchievements/i,e.achievementsBg=e.makeFlatScroll(e.toggleAchievements);var a={font:"18px pixel",fill:"#ffffff",stroke:"#000000",strokeThickness:3},s={font:"18px pixel",fill:"#000000"},n=game.add.graphics(0,0);n.fixedToCamera=!0,n.beginFill(16777215),n.drawRect(e.achievementsBg.x+40,e.achievementsBg.y+40,e.achievementsHolderWidth-100,300),n.endFill();var r=0;e.achievementsBg.holders=[];for(var c=0;c<e.nbAchievements;c++)c>0&&c%i==0&&r++,e.achievementsBg.holders.push(e.achievementsBg.addChild(game.add.sprite(40+r*e.achievementsHolderWidth,50+c%4*62,"atlas1","achievementholder"))),e.achievementsBg.holders[c].addChild(game.add.text(75,13,t[c].name,a)),e.achievementsBg.holders[c].addChild(game.add.text(295,15,t[c].desc,s)),e.achievementsBg.holders[c].mask=n;e.achievementsBg.leftArrow=e.achievementsBg.addChild(game.add.button(345,315,"atlas1",function(){e.changeAchievementsPage("left")},this,"arrows_2","arrows_2","arrows_4")),e.achievementsBg.rightArrow=e.achievementsBg.addChild(game.add.button(412,315,"atlas1",function(){e.changeAchievementsPage("right")},this,"arrows_3","arrows_3","arrows_5")),e.achievementsBg.leftArrow.input.useHandCursor=!1,e.achievementsBg.rightArrow.input.useHandCursor=!1,e.achievementsBg.completed=e.achievementsBg.addChild(game.add.text(645,325,"",{font:"18px pixel",fill:"#ffffff",stroke:"#000000",strokeThickness:3})),e.updateAchievements(),e.updateAchievementsArrows()};e.makeDeathScroll=function(){e.deathScroll=Home.makeScroll(),Home.setFadeTweens(e.deathScroll);var t=e.deathScroll.addChild(game.add.text(0,125,"You died...",{font:"30px pixel",fill:"#ffffff",stroke:"#000000",strokeThickness:3}));t.x=e.deathScroll.width/2-t.width/2;var i=e.deathScroll.addChild(game.add.button(0,210,"atlas1",e.revivePlayer,this,"revive_0","revive_0","revive_1"));i.x=e.deathScroll.width/2,i.anchor.set(.5,0)};e.makeFlatScroll=function(t){var i=game.add.sprite(80,32,"atlas1","achievements");i.fixedToCamera=!0,i.alpha=0,i.visible=!1,Home.setFadeTweens(i);var a=i.addChild(game.add.button(i.width-18,-14,"atlas1",t,this,"close_1","close_0","close_2"));return a.input.useHandCursor=!1,i};e.makeHelpScroll=function(){e.helpScroll=e.makeFlatScroll(e.toggleHelp),Home.makeTitle(e.helpScroll,"How to play");var t=130,i=200,a=270,s={font:"18px pixel"},n=e.helpScroll.addChild(game.add.sprite(55,t,"atlas1","mouse"));n.anchor.set(.5),e.helpScroll.addChild(game.add.text(100,t-10,e.db.texts.help_move,s));var r=e.helpScroll.addChild(game.add.sprite(55,i,"atlas1","enter"));r.anchor.set(.5),e.helpScroll.addChild(game.add.text(100,i-12,e.db.texts.help_chat,s));var c=e.helpScroll.addChild(game.add.sprite(55,a,"atlas3","clotharmor_31"));c.anchor.set(.5),e.helpScroll.addChild(game.add.text(100,a-10,e.db.texts.help_save,s))};e.makeOrientationScreen=function(){e.orientationContainer=game.add.sprite(0,0),e.orientationShade=e.orientationContainer.addChild(game.add.graphics(0,0)),e.orientationShade.beginFill(0,1),e.orientationShade.drawRect(0,0,game.width,game.height),e.orientationShade.endFill(),e.deviceImage=e.orientationContainer.addChild(game.add.sprite(game.width/2,game.height/2,"atlas1","device")),e.deviceImage.anchor.set(.5),e.rotateText=e.orientationContainer.addChild(game.add.text(0,0,e.db.texts.orient,{font:"40px pixel",fill:"#ffffff",stroke:"#000000",strokeThickness:3})),e.rotateText.x=game.width/2-e.rotateText.width/2,e.rotateText.y=e.deviceImage.y+e.deviceImage.height+20,e.rotateText.style.wordWrap=!0,e.rotateText.style.wordWrapWidth=400,e.orientationContainer.fixedToCamera=!0,e.orientationContainer.visible=!1};e.displayDeathScroll=function(){e.deathScroll||e.makeDeathScroll(),e.deathScroll.visible=!0,e.deathScroll.showTween.start()};e.displayError=function(){e.loadingText.text=e.db.texts.db_error,e.loadingText.x=game.width/2-e.loadingText.width/2,e.loadingText.y=game.height/2-e.loadingText.height/2};e.displayLoadingScreen=function(){e.loadingShade=game.add.graphics(0,0),e.loadingShade.beginFill(0,1),e.loadingShade.drawRect(e.borderPadding,e.borderPadding,game.stage.width-e.borderPadding*2,game.stage.height-e.borderPadding*2),e.loadingShade.endFill(),e.loadingText=game.add.text(0,0,e.db.texts.create,{font:"18px pixel",fill:"#ffffff",stroke:"#000000",strokeThickness:3}),e.loadingText.x=game.width/2-e.loadingText.width/2,e.loadingText.y=game.height/2-e.loadingText.height/2,e.loadingText.style.wordWrap=!0,e.loadingText.style.wordWrapWidth=400};e.displayOrientationScreen=function(){e.orientationContainer||e.makeOrientationScreen(),e.helpScroll&&e.helpScroll.visible&&e.toggleHelp(),e.achievementsBg&&e.achievementsBg.visible&&e.toggleAchievements(),e.orientationContainer.visible=!0};e.removeOrientationScreen=function(){e.orientationContainer.visible=!1};e.toggleHelp=function(){e.helpScroll||e.makeHelpScroll(),e.helpScroll.visible?(e.helpButton.freezeFrames=!1,e.helpButton.setFrames("helpicon_1","helpicon_0","helpicon_2"),e.helpScroll.hideTween.start()):(e.helpScroll.visible=!0,e.helpButton.freezeFrames=!0,e.helpScroll.showTween.start())};e.toggleAchievements=function(){e.achievementsBg||e.makeAchievementsScroll(),e.achievementsBg.visible?(e.achButton.freezeFrames=!1,e.achButton.setFrames("achievementicon_1","achievementicon_0","achievementicon_2"),e.achievementsBg.hideTween.start()):(e.achButton.freezeFrames=!0,e.achievementsBg.visible=!0,e.achievementsBg.showTween.start(),e.achTween.isRunning&&e.achTween.pause())};e.updateAchievements=function(){e.achievementsBg||e.makeAchievementsScroll();for(var t=e.db.achievements,i=0,a=0;a<e.nbAchievements;a++){var s=Client.hasAchievement(a);s&&i++,s&&(e.achievementsBg.holders[a].addChild(game.add.sprite(0,0,"atlas1","tokens_"+t[a].token)),e.achievementsBg.holders[a].getChildAt(0).addColor("#f4d442",0))}e.achievementsBg.completed.text="Completed "+i+"/"+e.nbAchievements};e.changeAchievementsPage=function(t){if(!(t=="right"&&e.currentAchievementsPage==e.maxAchievementsPage)&&!(t=="left"&&e.currentAchievementsPage==e.minAchievementsPage)){for(var i=t=="right"?-1:1,a=0;a<e.achievementsBg.holders.length;a++){var s=e.achievementsBg.holders[a],n=game.add.tween(s);n.to({x:s.x+i*e.achievementsHolderWidth},Phaser.Timer.SECOND*.4),n.start()}e.currentAchievementsPage+=-1*i,e.updateAchievementsArrows()}};e.updateAchievementsArrows=function(){e.currentAchievementsPage==e.maxAchievementsPage?e.achievementsBg.rightArrow.setFrames("arrows_1","arrows_1","arrows_1"):e.achievementsBg.rightArrow.setFrames("arrows_3","arrows_3","arrows_5"),e.currentAchievementsPage==e.minAchievementsPage?e.achievementsBg.leftArrow.setFrames("arrows_0","arrows_0","arrows_0"):e.achievementsBg.leftArrow.setFrames("arrows_2","arrows_2","arrows_4")};e.handleLootAchievement=function(t){var i=e.itemsInfo[e.itemsIDmap[t]];i.type!==void 0&&(i.type==1&&!e.weaponAchievement?(e.getAchievement(0),e.weaponAchievement=!0):i.type==2&&!e.armorAchievement&&(e.getAchievement(4),e.armorAchievement=!0))};e.handleSpeakAchievement=function(){e.getAchievement(3),e.speakAchievement=!0};e.handleKillAchievement=function(t){var i=localStorage.getItem("killed_"+t);i===void 0&&(i=0),i++,localStorage.setItem("killed_"+t,i);var a=e.monstersInfo[e.monstersIDmap[t]].achievement;e.db.achievements[a]&&i>=e.db.achievements[a].nb&&!Client.hasAchievement(a)&&e.getAchievement(a)};e.handleLocationAchievements=function(){if(!(e.inDoor||!e.locationAchievements.length))for(var t=e.computeTileCoords(e.player.x,e.player.y),i=e.locationAchievements.length-1;i>=0;i--){var a=e.locationAchievements[i];(a.criterion=="in"&&a.contains(t.x,t.y)||a.criterion=="out"&&!a.contains(t.x,t.y))&&(e.getAchievement(a.achID),e.locationAchievements.splice(i,1))}};e.getAchievement=function(t){Client.setAchievement(t),e.sounds.play("achievement"),e.achButton.blink=!1,e.achTween.isRunning||e.achTween.start(),e.achTween.isPaused&&e.achTween.resume(),e.achBar.visible=!0,e.achBar.upTween.start(),e.achBar.achName.text=e.db.achievements[t].name,e.achBar.achName.x=Math.floor(e.achBar.width/2-e.achBar.achName.width/2),e.updateAchievements()};e.findLocationAchievements=function(){e.locationAchievements=[],Object.keys(e.db.achievements).forEach(function(t){if(!Client.hasAchievement(t)){var i=e.db.achievements[t];if(i.locationAchievement){var a=new Phaser.Rectangle(i.rect.x,i.rect.y,i.rect.w,i.rect.h);a.criterion=i.criterion,a.achID=t,e.locationAchievements.push(a)}}})};e.adjacent=function(t,i){if(!t||!i)return 0;var a=e.computeTileCoords(t.x,t.y),s=e.computeTileCoords(i.x,i.y),n=a.x-s.x,r=a.y-s.y;return n==1&&r==0?1:n==0&&r==1?2:n==-1&&r==0?3:n==0&&r==-1?4:n==0&&r==0?-1:0};e.detectElement=function(t,i,a){var s=e.computeTileCoords(i,a);return t.getFirst(s.x,s.y)};e.computeFinalOrientation=function(t){var i=t[t.length-1],a=t[t.length-2];if(i.x<a.x)return 1;if(i.y<a.y)return 2;if(i.x>a.x)return 3;if(i.y>a.y)return 4};e.computeTileCoords=function(t,i){var a=e.map.gameLayers[0];return new Phaser.Point(a.getTileX(t),a.getTileY(i))};e.computeView=function(){e.view=new Phaser.Rectangle(game.camera.x+e.borderPadding,game.camera.y+e.borderPadding,game.camera.width-e.borderPadding*2,game.camera.height-e.borderPadding*2-e.HUDheight)};e.checkCameraBounds=function(){var t=e.computeTileCoords(e.player.x,e.player.y);e.cameraFollowing&&t.y<=e.mapWideningY&&game.camera.bounds.width==92*e.map.tileWidth?e.tweenCameraBounds(113):e.cameraFollowing&&t.y>e.mapWideningY&&game.camera.bounds.width==113*e.map.tileWidth&&e.tweenCameraBounds(92)};e.tweenCameraBounds=function(t){var i=game.add.tween(e.camera.bounds);i.to({width:t*e.map.tileWidth},1500,null,!1,0),i.start()};e.followPlayer=function(){e.inDoor=!1;var t=e.player.x>=92?113:92;game.camera.bounds=new Phaser.Rectangle(e.map.tileWidth-e.borderPadding,e.map.tileWidth-e.borderPadding,t*e.map.tileWidth,311*e.map.tileWidth),game.camera.follow(e.cameraFocus),e.cameraFollowing=!0};e.followPlayerIndoors=function(t,i,a,s){if(e.inDoor=!0,game.camera.follow(e.cameraFocus),t&&i&&a&&s){var n=Math.max((a-t)*e.map.tileWidth,game.width),r=(s-i)*e.map.tileHeight;game.camera.bounds=new Phaser.Rectangle(t*e.map.tileWidth,i*e.map.tileHeight,n,r)}else game.camera.bounds=new Phaser.Rectangle(e.map.tileWidth-e.borderPadding,e.map.tileWidth-e.borderPadding,170*e.map.tileWidth,311*e.map.tileWidth);e.cameraFollowing=!0};e.unfollowPlayer=function(){e.inDoor=!0,game.camera.unfollow(),game.camera.bounds=null,e.cameraFollowing=!1};e.addSounds=function(){var t=e.db.sounds;e.sounds=game.add.audio("sounds"),e.sounds.allowMultiple=!0,Object.keys(t.spritemap).forEach(function(i){var a=t.spritemap[i];e.sounds.addMarker(i,a.start,a.end-a.start)})};e.basicAnimation=function(t){for(var i=[],a=0;a<t.nbFrames;a++)i.push(t.frame+a);t.animations.add("idle",i,t.rate,!0),t.animations.play("idle")};e.basicAtlasAnimation=function(t){t.animations.add("idle",Phaser.Animation.generateFrameNames(t.atlasKey+"_",0,0+t.nbFrames-1),t.rate,!0),t.animations.play("idle")};e.displayHUD=function(){var t=e.borderPadding,i=game.height-e.borderPadding-e.HUDheight+6;e.barY=game.height-e.borderPadding-e.HUDheight,e.HUDbuttons=game.add.group(),e.displayChatBar(),e.displayAchievementDock(),e.HUD.add(game.add.sprite(e.borderPadding,e.barY,"atlas1","bar")),e.HUD.add(e.weaponIcon=game.add.sprite(e.borderPadding+210,e.barY,"atlas3")),e.HUD.add(e.armorIcon=game.add.sprite(e.borderPadding+244,e.barY+3,"atlas3")),e.HUDmessage=null,e.messages=game.add.group();for(var a=0;a<4;a++)e.messages.add(game.add.text(490,e.barY+5,"",{font:"16px pixel",fill:"#eeeeee"}));e.messages.setAll("fixedToCamera",!0),e.messages.setAll("anchor.x",.5),e.messages.setAll("exists",!1),e.nbConnectedText=e.HUD.add(game.add.text(745,e.barY+8,"0 players",{font:"16px pixel",fill:"#eeeeee"})),e.chatButton=e.HUDbuttons.add(game.add.button(850,e.barY+2,"atlas1",e.toggleChat,this,"talkicon_1","talkicon_0","talkicon_2")),e.achButton=e.HUDbuttons.add(game.add.button(880,e.barY+2,"atlas1",e.toggleAchievements,this,"achievementicon_1","achievementicon_0","achievementicon_2")),e.helpButton=e.HUDbuttons.add(game.add.button(910,e.barY+2,"atlas1",e.toggleHelp,this,"helpicon_1","helpicon_0","helpicon_2")),e.HUDbuttons.add(game.add.button(940,e.barY+2,"atlas1",function(n){game.sound.mute?game.sound.mute&&n.setFrames("soundicon_2","soundicon_2","soundicon_2"):n.setFrames("soundicon_1","soundicon_0","soundicon_1"),game.sound.mute=!game.sound.mute},this,"soundicon_2","soundicon_2","soundicon_2")),e.achTween=game.add.tween(e.achButton),e.achTween.to({},500,null,!1,0,-1),e.achTween.onLoop.add(function(n){n.blink=!n.blink,n.blink?e.achButton.setFrames("achievementicon_3","achievementicon_3","achievementicon_3"):e.achButton.setFrames("achievementicon_1","achievementicon_0","achievementicon_2")},this),e.createLifeBar(t,i),e.HUD.add(e.health),e.HUD.add(game.add.sprite(t,i,"atlas1","life")),e.HUD.add(e.HUDbuttons),e.HUD.setAll("fixedToCamera",!0),e.HUDbuttons.forEach(function(n){n.input.useHandCursor=!1});var s=game.input.keyboard.addKey(Phaser.Keyboard.ENTER);s.onDown.add(e.toggleChat,this)};e.displayChatBar=function(){e.chatBar=e.HUD.add(game.add.sprite(96,e.barY+1,"atlas1","chatbar")),e.chatBar.visible=!1,e.chatBar.upTween=game.add.tween(e.chatBar.cameraOffset),e.chatBar.downTween=game.add.tween(e.chatBar.cameraOffset),e.chatBar.upTween.to({y:e.barY-30},Phaser.Timer.SECOND/5),e.chatBar.downTween.to({y:e.barY+1},Phaser.Timer.SECOND/5),e.chatBar.downTween.onComplete.add(function(){e.chatBar.visible=!1},this),e.chatBar.upTween.onComplete.add(function(){e.chatInput.focusOutOnEnter=!0},this),e.chatInput=e.HUD.add(game.add.inputField(115,e.barY-20,{width:750,height:18,fillAlpha:0,cursorColor:"#fff",fill:"#fff",font:"14px pixel",max:e.maxChatLength})),e.chatInput.visible=!1,e.chatInput.focusOutOnEnter=!1,e.chatInput.input.useHandCursor=!1};e.displayAchievementDock=function(){e.achBar=e.HUD.add(game.add.sprite(274,e.barY+1,"atlas1","newach")),e.achBar.visible=!1,e.achBar.upTween=game.add.tween(e.achBar.cameraOffset),e.achBar.downTween=game.add.tween(e.achBar.cameraOffset),e.achBar.upTween.to({y:e.barY-68},Phaser.Timer.SECOND/5),e.achBar.downTween.to({y:e.barY+1},Phaser.Timer.SECOND/5,null,!1,Phaser.Timer.SECOND*5),e.achBar.downTween.onComplete.add(function(){e.achBar.visible=!1},this),e.achBar.upTween.onComplete.add(function(){e.achBar.downTween.start()},this),e.achBar.addChild(game.add.sprite(192,-35,"atlas1","tokens_0"));var t=e.achBar.addChild(game.add.sprite(192,-35,"atlas1","achsparks_0")),i=Phaser.Animation.generateFrameNames("achsparks_",0,5);t.animations.add("glitter",i,7,!0),t.play("glitter");var a={font:"14px pixel",fill:"#f4d442",stroke:"#000000",strokeThickness:3},s={font:"16px pixel",fill:"#ffffff",stroke:"#000000",strokeThickness:3};e.achBar.addChild(game.add.text(133,20,"New Achievement Unlocked!",a)),e.achBar.achName=e.achBar.addChild(game.add.text(133,40,"A true Warrior!",s))};e.computeLifeBarWidth=function(){return Math.max(e.healthBarWidth*(e.player.life/e.player.maxLife),1)};e.createLifeBar=function(t,i){var a=e.computeLifeBarWidth();e.health=game.add.sprite(t+20,i+4),e.health.addChild(game.add.tileSprite(0,0,a,18,"life",0)),e.health.addChild(game.add.sprite(a,0,"life",1))};e.createMarker=function(){e.markerGroup=game.add.group(),e.marker=e.markerGroup.add(game.add.sprite(0,0,"atlas1")),e.marker.alpha=.5,e.marker.canSee=!0,e.marker.collide=!1,game.canvas.style.cursor=e.cursor};e.updateMarker=function(t,i,a){e.marker.position.set(t,i),e.marker.frameName=a?"marker_1":"marker_0",e.marker.collide=a};e.messageIn=function(t){var i=e.messages.getFirstExists(!1);i.exists=!0,i.alpha=0,i.text=t,i.cameraOffset.y=e.barY+20;var a=game.add.tween(i.cameraOffset),s=game.add.tween(i);a.to({y:e.barY+8},Phaser.Timer.SECOND/5),s.to({alpha:1},Phaser.Timer.SECOND/5),a.start(),s.start(),e.HUDmessage&&e.messageOut(e.HUDmessage),e.HUDmessage=i;var n=game.add.tween(i);n.to({},Phaser.Timer.SECOND*3),n.onComplete.add(e.messageOut,this),n.start()};e.messageOut=function(t){var i=game.add.tween(t.cameraOffset),a=game.add.tween(t);i.to({y:e.barY},Phaser.Timer.SECOND/5),a.to({alpha:0},Phaser.Timer.SECOND/5),i.start(),a.start(),a.onComplete.add(function(s){s.exists=!1},this),e.HUDmessage=null};e.toggleChat=function(){if(e.chatBar.visible){if(e.chatButton.frameName="talkicon_0",e.chatButton.freezeFrames=!1,e.chatInput.focusOutOnEnter=!1,e.chatInput.visible=!1,e.chatInput.endFocus(),e.chatBar.downTween.start(),e.chatInput.text.text){var t=e.chatInput.text.text;e.player.displayBubble(t),Client.sendChat(t)}e.chatInput.resetText()}else e.chatButton.frameName="talkicon_2",e.chatButton.freezeFrames=!0,e.chatBar.visible=!0,e.chatInput.visible=!0,e.chatInput.startFocus(),e.chatBar.upTween.start()};e.updateNbConnected=function(t){e.nbConnectedText&&(e.nbConnected=t,e.nbConnectedText.text=e.nbConnected+" player"+(e.nbConnected>1?"s":""))};e.displayMap=function(){e.groundMapLayers=game.add.group(),e.highMapLayers=game.add.group(),e.map=game.add.tilemap("map"),e.map.addTilesetImage("tilesheet","tileset"),e.map.gameLayers=[];for(var t=0;t<e.map.layers.length;t++){var i=t<=e.nbGroundLayers-1?e.groundMapLayers:e.highMapLayers;e.map.gameLayers[t]=e.map.createLayer(e.map.layers[t].name,0,0,i),e.map.gameLayers[t].visible=!1}e.map.gameLayers[0].inputEnabled=!0,e.map.gameLayers[0].events.onInputUp.add(e.handleMapClick,this),e.createDoorsMap(),game.world.setBounds(0,0,e.map.widthInPixels,e.map.heightInPixels),e.map.tileset={gid:1,tileProperties:e.map.tilesets[0].tileProperties},e.createCollisionArray()};e.createCollisionArray=function(){e.collisionArray=[];for(var t=0;t<e.map.height;t++){for(var i=[],a=0;a<e.map.width;a++){for(var s=!1,n=0;n<e.map.gameLayers.length;n++){var r=e.map.getTile(a,t,e.map.gameLayers[n]);if(r){var c=e.map.tileset.tileProperties[r.index-e.map.tileset.gid];if(c&&c.hasOwnProperty("c")){s=!0;break}}}i.push(+s)}e.collisionArray.push(i)}e.easystar.setGrid(e.collisionArray),e.easystar.setAcceptableTiles([0])};e.createDoorsMap=function(){e.doors=new spaceMap;for(var t=0;t<e.map.objects.doors.length;t++){var i=e.map.objects.doors[t],a=e.computeTileCoords(i.x,i.y);e.doors.add(a.x,a.y,{to:new Phaser.Point(i.properties.x*e.map.tileWidth,i.properties.y*e.map.tileWidth),camera:i.properties.hasOwnProperty("cx")?new Phaser.Point(i.properties.cx*e.map.tileWidth,i.properties.cy*e.map.tileWidth):null,orientation:i.properties.o,follow:i.properties.hasOwnProperty("follow"),min_cx:i.properties.min_cx,min_cy:i.properties.min_cy,max_cx:i.properties.max_cx,max_cy:i.properties.max_cy})}};e.displayScenery=function(){var t=e.db.scenery.scenery;e.groundMapLayers.forEach(function(i){for(var a=0;a<t.length;a++)e.map.createFromTiles(e.map.tileset.gid+t[a].id,-1,"tileset",i,e.scenery,{frame:t[a].frame,nbFrames:t[a].nbFrames,rate:2})}),e.scenery.setAll("visible",!1),e.scenery.forEach(e.basicAnimation,this)};e.displayNPC=function(){for(var t=game.cache.getJSON("entities"),i=0;i<e.map.objects.entities.length;i++){var a=e.map.objects.entities[i];if(t.hasOwnProperty(a.gid-1961)){var s=t[a.gid-1961];s.npc&&e.basicAtlasAnimation(e.entities.add(new NPC(a.x,a.y,s.sprite)))}}};e.enableClick=function(){this.clickEnabled=!0};e.disableClick=function(){this.clickEnabled=!1};e.handleClick=function(){return this.clickEnabled?(game.time.events.add(this.clickDelay,this.enableClick,this),e.disableClick(),!0):!1};e.handleCharClick=function(t){if(e.handleClick()){var i=e.computeTileCoords(t.x,t.y);i.y++;var a=t.x+"_"+t.y,s;e.player.dialoguesMemory.hasOwnProperty(a)?e.player.dialoguesMemory[a]>=t.dialogue.length&&(e.player.dialoguesMemory[a]=-1):e.player.dialoguesMemory[a]=0,s=e.player.dialoguesMemory[a]++;var n={action:1,id:a,text:s>=0?t.dialogue[s]:"",character:t};e.player.prepareMovement(i,2,n,0,!0)}};e.handleChestClick=function(t){if(e.handleClick()){var i=e.computeTileCoords(t.x,t.y),a={action:4,x:i.x,y:i.y};e.player.prepareMovement(i,0,a,0,!0)}};e.handleLootClick=function(t){e.handleClick()&&e.player.prepareMovement(e.computeTileCoords(t.x,t.y),0,{action:0},0,!0)};e.handleMapClick=function(t,i){if(e.handleClick()&&!e.marker.collide&&e.view.contains(i.worldX,i.worldY)){var a=e.computeTileCoords(e.marker.x,e.marker.y);e.player.prepareMovement(a,0,{action:0},0,!0)}};e.handleMonsterClick=function(t){if(e.handleClick()){var i=e.computeTileCoords(t.x,t.y),a={action:3,id:t.id};e.player.prepareMovement(i,0,a,0,!0)}};e.manageMoveTarget=function(t,i){var a=t*e.map.tileWidth,s=i*e.map.tileWidth;e.moveTarget?(e.moveTarget.visible=!0,e.moveTarget.x=a,e.moveTarget.y=s):(e.moveTarget=e.markerGroup.add(game.add.sprite(a,s,"atlas1")),e.moveTarget.animations.add("rotate",Phaser.Animation.generateFrameNames("target_",0,3),15,!0),e.moveTarget.animations.play("rotate")),e.marker.visible=!1};e.setHoverCursors=function(t,i){t.inputEnabled=!0,t.events.onInputOver.add(function(){game.canvas.style.cursor=i,e.marker.canSee=!1},this),t.events.onInputOut.add(function(){game.canvas.style.cursor=e.cursor,e.marker.canSee=!0},this),t.events.onDestroy.add(function(){game.canvas.style.cursor=e.cursor,e.marker.canSee=!0},this)};e.resetHoverCursors=function(t){t.events.onInputOver.removeAll(),t.events.onInputOut.removeAll()};var J={heal:{fill:"#00ad00",stroke:"#005200"},hurt:{fill:"#ad0000",stroke:"#520000"},hit:{fill:"#ffffff",stroke:"#000000"}};e.makeHPtexts=function(){e.HPGroup=game.add.group();for(var t=0;t<60;t++)e.HPGroup.add(game.add.text(0,0,"",{font:"20px pixel",strokeThickness:2}));e.HPGroup.setAll("exists",!1)};e.displayHP=function(t,i,a,s){var n=e.HPGroup.getFirstExists(!1);n.text=t,n.fill=J[i].fill,n.stroke=J[i].stroke,n.lifespan=Phaser.Timer.SECOND*2,n.alpha=1,n.x=a.x+10,n.y=a.y-30;var r=game.add.tween(n);r.to({y:n.y-25,alpha:0},Phaser.Timer.SECOND*2,null,!1,s),r.start(),n.exists=!0};e.playerSays=function(t,i){var a=e.charactersPool[t];a.displayBubble(i)};e.makeBubble=function(){var t=game.add.sprite(0,0);t.addChild(game.add.sprite(0,0,"bubble",0)),t.addChild(game.add.tileSprite(e.speechBubbleCornerSize,0,0,e.speechBubbleCornerSize,"bubble",1)),t.addChild(game.add.sprite(0,0,"bubble",2)),t.addChild(game.add.tileSprite(0,e.speechBubbleCornerSize,e.speechBubbleCornerSize,0,"bubble",3)),t.addChild(game.add.tileSprite(e.speechBubbleCornerSize,e.speechBubbleCornerSize,0,0,"bubble",4)),t.addChild(game.add.tileSprite(0,e.speechBubbleCornerSize,e.speechBubbleCornerSize,0,"bubble",5)),t.addChild(game.add.sprite(0,0,"bubble",6)),t.addChild(game.add.tileSprite(e.speechBubbleCornerSize,0,0,e.speechBubbleCornerSize,"bubble",7)),t.addChild(game.add.sprite(0,0,"bubble",8)),t.addChild(game.add.sprite(0,0,"atlas1","tail"));var i=t.addChild(game.add.text(0,0,"",{font:"14px pixel",fill:"#ffffff",stroke:"#000000",strokeThickness:2}));return i.maxWidth=200,i.alpha=1.5,t};e.markerHasMoved=function(){return e.previousMarkerPosition.x!=e.markerPosition.x||e.previousMarkerPosition.y!=e.markerPosition.y};e.sortEntities=function(){e.entities.sort("y",Phaser.Group.SORT_ASCENDING)};e.update=function(){if(e.playerIsInitialized){var t=e.computeTileCoords(game.input.activePointer.worldX,game.input.activePointer.worldY);if(e.markerPosition.x=t.x*e.map.tileWidth,e.markerPosition.y=t.y*e.map.tileWidth,e.chatInput.visible&&!e.chatInput.focus&&e.toggleChat(),e.player.hasMoved()&&e.checkCameraBounds(),e.markerHasMoved()&&(e.computeView(),e.marker.visible=e.marker.canSee&&e.view.contains(e.markerPosition.x,e.markerPosition.y),e.marker.visible)){for(var i=!1,a=0;a<e.map.gameLayers.length;a++){var s=e.map.getTile(t.x,t.y,e.map.gameLayers[a]);if(s){var n=e.map.tileset.tileProperties[s.index-e.map.tileset.gid];if(n&&n.hasOwnProperty("c")){i=!0;break}}}e.updateMarker(e.markerPosition.x,e.markerPosition.y,i),e.previousMarkerPosition.set(e.markerPosition.x,e.markerPosition.y)}}};e.render=function(){};var l={maxNameLength:20};window.Home=l;l.init=function(){game.device.desktop==!1&&(console.log("W : "+window.screen.width+", H : "+window.screen.height),Math.min(window.screen.width,window.screen.height)<game.width&&(game.scale.scaleMode=Phaser.ScaleManager.RESIZE,game.scale.forceOrientation(!0,!1))),game.scale.pageAlignHorizontally=!0,game.add.plugin(Fabrique.Plugins.InputField),Game.isNewPlayer=Client.isNewPlayer()};l.preload=function(){game.load.atlasJSONHash("atlas1","assets/sprites/atlas1.png","assets/sprites/atlas1.json"),game.load.atlasJSONHash("atlas3","assets/sprites/atlas3.png","assets/sprites/atlas3.json"),game.load.json("db","assets/json/db.json"),game.load.audio("intro",["assets/music/phaser-quest-intro.ogg"])};l.create=function(){Game.db=game.cache.getJSON("db"),game.device.desktop==!1&&(game.scale.enterIncorrectOrientation.add(Game.displayOrientationScreen,this),game.scale.leaveIncorrectOrientation.add(Game.removeOrientationScreen,this)),Game.isNewPlayer||l.makeResetScroll(),l.displayHomeScroll(),l.displayLogo(),l.displayLinks(),l.music=game.add.audio("intro"),l.music.play(),document.onkeydown=l.handleKeyPress};l.displayHomeScroll=function(){l.scroll||l.makeHomeScroll(),l.resetScroll&&l.resetScroll.visible&&l.resetScroll.hideTween.start(),l.scroll.visible=!0,l.scroll.showTween.start()};l.displayLogo=function(){l.logo=game.add.sprite(0,20,"atlas1","logo"),l.logo.anchor.set(.5,0),l.logo.x=game.width/2,l.logo.hideTween=game.add.tween(l.logo),l.logo.hideTween.to({alpha:0},Phaser.Timer.SECOND*.2)};l.displayLinks=function(){var t=l.makeLink(300,"About",function(){window.open("https://www.educative.io/","_blank")},!0);t=l.makeLink(t+30,"Credits",function(){console.log("credits")},!0),t=l.makeLink(t+30,"License",function(){console.log("license")},!0)};l.makeLink=function(t,i,a,s){var n="#b2af9b",r={font:"18px pixel",fill:n},c=430,h=game.add.text(t,c,i,r);if(h.inputEnabled=!0,h.events.onInputOver.add(function(y){y.addColor("#f4d442",0)},this),h.events.onInputOut.add(function(y){y.addColor(n,0)},this),h.events.onInputDown.add(a,this),s){var s=game.add.text(h.x+h.width+10,c," - ",r);return s.x}return h.x};l.makeScroll=function(){var t=game.add.sprite(0,0,"atlas1","scroll_1");return t.x=game.width/2-t.width/2,t.y=game.height/2-t.height/2,t.addChild(game.add.sprite(-78,0,"atlas1","scroll_3")),t.addChild(game.add.sprite(t.width,0,"atlas1","scroll_2")),t.fixedToCamera=!0,t.alpha=0,t.visible=!1,t};l.setFadeTweens=function(t){var i=.2;t.showTween=game.add.tween(t),t.hideTween=game.add.tween(t),t.showTween.to({alpha:1},Phaser.Timer.SECOND*i),t.hideTween.to({alpha:0},Phaser.Timer.SECOND*i),t.hideTween.onComplete.add(function(){t.visible=!1},this)};l.makeHomeScroll=function(){Game.isNewPlayer=Client.isNewPlayer(),l.scroll=l.makeScroll(),l.setFadeTweens(l.scroll),l.makeTitle(l.scroll,Game.isNewPlayer?"Create a new character":"Load existing character");var t,i;if(Game.isNewPlayer)i=l.scroll.addChild(game.add.sprite(0,110,"atlas3","clotharmor_31")),i.alpha=.5,l.inputField=l.scroll.addChild(game.add.inputField(185,160,{width:300,padding:10,fill:"#000",stroke:"#fff",backgroundColor:"#d0cdba",borderWidth:2,borderColor:"#b2af9b",borderRadius:3,font:"18px pixel",placeHolder:"Name your character",placeHolderColor:"#b2af9b",cursorColor:"#b2af9b",max:l.maxNameLength})),l.inputField.x=l.scroll.width/2-l.inputField.width/2,l.inputField.input.useHandCursor=!1,t=220;else{i=l.scroll.addChild(game.add.sprite(0,100,"atlas3",Client.getArmor()+"_31"));var a=Client.getWeapon(),s=i.addChild(game.add.sprite(0,0,"atlas3",a+"_31"));s.position.set(Game.db.items[a].offsets.x,Game.db.items[a].offsets.y);var n=i.addChild(game.add.text(0,42,Client.getName(),{font:"18px pixel",fill:"#fff",stroke:"#000000",strokeThickness:3}));n.x=Math.floor(12-n.width/2),l.makeScrollLink(l.scroll,"Reset your character",l.displayResetScroll),t=180}i.addChild(game.add.sprite(0,5,"atlas1","shadow")),i.anchor.set(.25,.35),l.button=l.makeButton(l.scroll,t,"play",l.startGame),Game.isNewPlayer&&l.disableButton(),i.x=l.button.x-18};l.makeTitle=function(t,i){var a=65,s=t.addChild(game.add.text(0,a,i,{font:"18px pixel",fill:"#f4d442",stroke:"#000000",strokeThickness:3}));s.x=t.width/2,s.anchor.set(.5),t.addChild(game.add.sprite(s.x-170,a-12,"atlas1","stache_0")),t.addChild(game.add.sprite(s.x+105,a-12,"atlas1","stache_1"))};l.makeButton=function(t,i,a,s){var n=t.addChild(game.add.button(210,i,"atlas1",s,this,a+"_0",a+"_0",a+"_1"));return n.x=t.width/2,n.anchor.set(.5,0),n.input.useHandCursor=!1,n};l.makeScrollLink=function(t,i,a){var s=t.addChild(game.add.text(0,310,i,{font:"16px pixel",fill:"#fff",stroke:"#000",strokeThickness:3}));s.x=t.width/2,s.anchor.set(.5),s.inputEnabled=!0,s.events.onInputOver.add(function(n){n.addColor("#f4d442",0)},this),s.events.onInputOut.add(function(n){n.addColor("#fff",0)},this),s.events.onInputDown.add(a,this)};l.displayResetScroll=function(){l.resetScroll||l.makeResetScroll(),l.scroll.hideTween.start(),l.resetScroll.visible=!0,l.resetScroll.showTween.start()};l.makeResetScroll=function(){l.resetScroll=l.makeScroll(),l.setFadeTweens(l.resetScroll),l.makeTitle(l.resetScroll,"Reset your character?");var t=l.resetScroll.addChild(game.add.text(0,135,"All your progress will be lost. Are you sure?",{font:"18px pixel",fill:"#000"}));l.makeButton(l.resetScroll,180,"delete",l.deletePlayer),t.anchor.set(.5),t.x=l.resetScroll.width/2,l.makeScrollLink(l.resetScroll,"Cancel",l.displayHomeScroll)};l.deletePlayer=function(){Client.deletePlayer(),l.scroll.destroy(),l.scroll=null,l.displayHomeScroll()};l.isNameEmpty=function(){return l.inputField.text.text.length==0};l.startGame=function(){var t=!0;Game.isNewPlayer&&(l.isNameEmpty()?t=!1:Client.setName(l.inputField.text.text)),t&&(document.onkeydown=null,l.scroll.hideTween.onComplete.add(function(){game.state.start("Game")},this),l.scroll.hideTween.start(),l.logo.hideTween.start())};l.disableButton=function(){l.button.setFrames("play_2","play_2","play_2"),l.button.inputEnabled=!1};l.enableButton=function(){l.button.setFrames("play_0","play_0","play_1"),l.button.inputEnabled=!0};l.handleKeyPress=function(t){t=t||window.event,t.keyCode==13&&l.startGame()};l.update=function(){l.inputField&&(l.inputField.update(),l.button.inputEnabled?l.isNameEmpty()&&l.disableButton():l.isNameEmpty()||l.enableButton())};function R(t,i,a){Being.call(this,t,i,a)}window.Human=R;R.prototype=Object.create(Being.prototype);R.prototype.constructor=R;R.prototype.generateBubble=function(){this.bubble=Game.makeBubble(),this.bubble.alpha=.6,this.bubble.exists=!1};R.prototype.displayBubble=function(t,i=null){var a=200;if(!t){this.bubble&&this.killBubble();return}this.bubble||this.generateBubble(),this.bubble.exists=!0;var s=this.bubble.getChildAt(10);s.text=t,i&&(s.inputEnabled=!0,s.input.useHandCursor=!0,s.events.onInputUp.add(function(){window.open(i,"_blank")},this)),s.style.wordWrap=!0,s.style.wordWrapWidth=a;var n=Phaser.Math.clamp(s.width,30,a);n%2!=0&&n++;var r=s.height,c=Game.speechBubbleCornerSize,h=c+n,y=Game.speechBubbleCornerSize,g=y+r,w=(n+2*Game.speechBubbleCornerSize)/2,b=g+Game.speechBubbleCornerSize;this.bubble.lifespan=Phaser.Timer.SECOND*5,s.anchor.x=.5,s.x=n/2+Game.speechBubbleCornerSize,s.y=y,this.bubble.getChildAt(1).width=n,this.bubble.getChildAt(2).x=h,this.bubble.getChildAt(3).height=r,this.bubble.getChildAt(4).width=n,this.bubble.getChildAt(4).height=r,this.bubble.getChildAt(5).x=h,this.bubble.getChildAt(5).height=r,this.bubble.getChildAt(6).y=g,this.bubble.getChildAt(7).width=n,this.bubble.getChildAt(7).y=g,this.bubble.getChildAt(8).x=h,this.bubble.getChildAt(8).y=g,this.bubble.getChildAt(9).x=w,this.bubble.getChildAt(9).y=b,this.bubble.postUpdate=function(){this.bubble.x=this.x-(w-20),this.bubble.y=this.y+(this==Game.player?-this.height:-(this.height+13))-s.height+16}.bind(this),Game.sounds.play("chat")};R.prototype.killBubble=function(){this.bubble.kill()};function N(t,i,a){Phaser.Sprite.call(this,game,t,i,a),game.add.existing(this),this.events.onKilled.addOnce(function(s){s.recycle()},this)}window.Item=N;N.prototype=Object.create(Phaser.Sprite.prototype);N.prototype.constructor=N;N.prototype.setUp=function(t,i,a,s,n,r){Game.entities.add(this),this.chest=i,this.inChest=a,this.content=t,this.canRespawn=n,this.loot=r,this.visible=s,this.display(),this.visible||this.kill()};N.prototype.display=function(){this.absorbProperties(Game.itemsInfo[this.content]),this.shadow||(this.shadow=this.addChild(game.add.sprite(1,0,"atlas1","shadow"))),this.sparks||(this.sparks=this.addChild(game.add.sprite(0,0,"atlas1","sparks_0")),this.sparks.animations.add("glitter",Phaser.Animation.generateFrameNames("sparks_",0,5),10,!0)),this.sparks.animations.play("glitter"),this.rate=6,this.atlasKey=this.content;try{this.inputEnabled=!0,Game.setHoverCursors(this,Game.lootCursor)}catch(t){console.log(t)}this.chest?(this.animations.add("open",Phaser.Animation.generateFrameNames("death_",0,5),8,!1),this.events.onAnimationComplete.add(function(t){t.swapToItem()},this),this.swapToChest()):this.swapToItem()};N.prototype.setBlinkingTween=function(){var t=game.add.tween(this);this.blinkingTween=t;var i=0;t.to({},200,null,!1,Phaser.Timer.SECOND*5,-1),t.onLoop.add(function(a){a.visible=!a.visible,i++,i>=20&&this.kill()},this),t.start()};N.prototype.swapToChest=function(){this.frameName="chest",this.anchor.set(0),this.inChest=!0,this.shadow.visible=!1,this.sparks.visible=!1,this.events.onInputUp.removeAll(),this.events.onInputUp.add(Game.handleChestClick,this),Game.fadeInTween(this)};N.prototype.swapToItem=function(){this.frameName!=this.content&&(this.frameName=this.content+"_0"),this.customAnchor?this.anchor.set(this.customAnchor.x,this.customAnchor.y):this.anchor.set(0,.25),this.inChest=!1,this.shadow.visible=!0,this.sparks.visible=!0,(this.chest||this.loot)&&this.setBlinkingTween(),Game.basicAtlasAnimation(this),this.events.onInputUp.removeAll(),this.events.onInputUp.add(Game.handleLootClick,this)};N.prototype.remove=function(){this.canRespawn?this.kill():(this.destroy(),delete Game.itemsTable[this.id])};N.prototype.recycle=function(){this.blinkingTween&&this.blinkingTween.stop()};N.prototype.open=function(){this.animations.play("open"),Game.sounds.play("chest")};N.prototype.respawn=function(){this.revive(),this.chest?this.swapToChest():(this.swapToItem(),Game.fadeInTween(this))};var X=new Phaser.Game(980,500,navigator.userAgent.toLowerCase().indexOf("firefox")>-1?Phaser.CANVAS:Phaser.AUTO,document.getElementById("game"),null,!0,!1);window.game=X;X.state.add("Home",Home);X.state.add("Game",Game);X.state.start("Home");function U(t,i,a){Being.call(this,t,i,a),this.isPlayer=!1,this.addChild(game.add.sprite(0,0,"atlas1","shadow")),Game.setHoverCursors(this,Game.fightCursor),this.inputEnabled=!0,this.events.onInputUp.add(Game.handleMonsterClick,this),this.inFight=!1,this.orientation=game.rnd.between(1,4),this.initialPosition=new Phaser.Point(t,i)}window.Monster=U;U.prototype=Object.create(Being.prototype);U.prototype.constructor=U;U.prototype.setUp=function(t){this.frameName=t+"_0",this.monsterName=t,this.anchor.set(.25,.2),this.absorbProperties(Game.monstersInfo[t]),this.customAnchor&&(this.anchor.x=this.customAnchor.x,this.anchor.y=this.customAnchor.y),this.maxLife=this.life,Game.entities.add(this),this.setAnimations(this),this.idle(!1)};U.prototype.prepareMovement=function(t,i,a){t&&(this.tween&&this.stopMovement(!1),this.pathfindingCallback(0,i,a,!1,t))};U.prototype.fight=function(){this.inFight=!0,this.fightTween=game.add.tween(this),this.fightTween.to({},Phaser.Timer.SECOND,null,!1,150,-1),this.fightTween.onStart.add(function(){this.fightAction()},this),this.fightTween.onLoop.add(function(){this.fightAction()},this),this.fightTween.start()};U.prototype.fightAction=function(){if(!(Date.now()-this.lastAttack<900)&&(this.lastAttack=Date.now(),!!this.target&&!this.target.isPlayer)){var t=Game.adjacent(this,this.target);t>0&&(this.tween&&(this.tween.stop(),this.tween=null),this.orientation=t,this.attack())}};U.prototype.die=function(t){this.endFight(),this.target=null,this.alive=!1,t&&(this.animate("death",!1),Game.sounds.play("kill2")),this.delayedKill(500)};U.prototype.respawn=function(){this.revive(),this.orientation=game.rnd.between(1,4),this.position.set(this.initialPosition.x,this.initialPosition.y),this.life=this.maxLife,this.idle(!0),Game.fadeInTween(this)};function $(t,i,a){Human.call(this,t,i,"atlas1"),this.rate=2,this.absorbProperties(Game.npcInfo[a]),this.customAnchor?this.anchor.set(this.customAnchor.x,this.customAnchor.y):this.anchor.set(0,.25),this.addChild(game.add.sprite(0,4,"atlas1","shadow")),Game.setHoverCursors(this,Game.talkCursor);var s=Game.computeTileCoords(this.x,this.y);Game.collisionArray[s.y][s.x]=1,this.events.onInputUp.add(Game.handleCharClick,this)}window.NPC=$;$.prototype=Object.create(Human.prototype);$.prototype.constructor=$;/*!
 * phaser-input - version 1.2.5 
 * Adds input boxes to Phaser like CanvasInput, but also works for WebGL and Mobile, made for Phaser only.
 *
 * OrangeGames
 * Build at 08-08-2016
 * Released under MIT License 
 */var B;(function(t){(function(s){s[s.text=0]="text",s[s.password=1]="password",s[s.number=2]="number"})(t.InputType||(t.InputType={}));var i=t.InputType,a=function(){function s(n,r,c,h){var y=this;c===void 0&&(c=i.text),this.focusIn=new Phaser.Signal,this.focusOut=new Phaser.Signal,this.id=r,this.type=c,this.game=n,this.element=document.createElement("input"),this.element.id=r,this.element.style.position="absolute",this.element.style.top=(-100).toString()+"px",this.element.style.left=(-100).toString()+"px",this.element.value=this.value,this.element.type=i[c],this.element.addEventListener("focusin",function(){y.focusIn.dispatch()}),this.element.addEventListener("focusout",function(){y.focusOut.dispatch()}),document.body.appendChild(this.element)}return s.prototype.addKeyUpListener=function(n){this.callback=n,document.addEventListener("keyup",this.callback)},s.prototype.blockKeyDownEvents=function(){document.addEventListener("keydown",this.preventKeyPropagation)},s.prototype.preventKeyPropagation=function(n){n.stopPropagation?n.stopPropagation():event.cancelBubble=!0},s.prototype.unblockKeyDownEvents=function(){document.removeEventListener("keydown",this.preventKeyPropagation)},s.prototype.removeEventListener=function(){document.removeEventListener("keyup",this.callback)},s.prototype.destroy=function(){document.body.removeChild(this.element)},s.prototype.setMax=function(n,r){if(n!==void 0){if(this.type===i.text||this.type===i.password)this.element.maxLength=parseInt(n,10);else if(this.type===i.number){if(this.element.max=n,r===void 0)return;this.element.min=r}}},Object.defineProperty(s.prototype,"value",{get:function(){return this.element.value},set:function(n){this.element.value=n},enumerable:!0,configurable:!0}),s.prototype.focus=function(){var n=this;if(this.element.focus(),!this.game.device.desktop&&this.game.device.chrome)var r=window.innerWidth,c=window.innerHeight,h=!1,y=setInterval(function(){(r>window.innerWidth||c>window.innerHeight)&&(h=!0),h&&r===window.innerWidth&&c===window.innerHeight&&(n.focusOut.dispatch(),clearInterval(y))},50)},s.prototype.blur=function(){this.element.blur()},Object.defineProperty(s.prototype,"hasSelection",{get:function(){return this.type===i.number?!1:this.element.selectionStart!==this.element.selectionEnd},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"caretStart",{get:function(){return this.element.selectionEnd},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"caretEnd",{get:function(){return this.element.selectionStart},enumerable:!0,configurable:!0}),s.prototype.getCaretPosition=function(){return this.type===i.number?-1:this.element.selectionStart},s.prototype.setCaretPosition=function(n){this.type!==i.number&&this.element.setSelectionRange(n,n)},s}();t.InputElement=a})(B||(B={}));var K=globalThis&&globalThis.__extends||function(t,i){function a(){this.constructor=t}for(var s in i)i.hasOwnProperty(s)&&(t[s]=i[s]);t.prototype=i===null?Object.create(i):(a.prototype=i.prototype,new a)},B;(function(t){var i=function(a){function s(n,r,c,h){var y=this;switch(h===void 0&&(h={}),a.call(this,n,r,c),this.focusOutOnEnter=!0,this.placeHolder=null,this.box=null,this.focus=!1,this.value="",this.windowScale=1,this.blockInput=!0,this.blink=!0,this.cnt=0,this.inputOptions=h,this.inputOptions.width=h.width||150,this.inputOptions.padding=h.padding||0,this.inputOptions.textAlign=h.textAlign||"left",this.inputOptions.type=h.type||t.InputType.text,this.inputOptions.borderRadius=h.borderRadius||0,this.inputOptions.height=h.height||14,this.inputOptions.fillAlpha=h.fillAlpha===void 0?1:h.fillAlpha,this.inputOptions.selectionColor=h.selectionColor||"rgba(179, 212, 253, 0.8)",this.inputOptions.zoom=n.device.desktop?!1:h.zoom||!1,this.box=new t.InputBox(this.game,h),this.setTexture(this.box.generateTexture()),this.textMask=new t.TextMask(this.game,h),this.addChild(this.textMask),this.domElement=new t.InputElement(this.game,"phaser-input-"+(1e4*Math.random()|0).toString(),this.inputOptions.type,this.value),this.domElement.setMax(this.inputOptions.max,this.inputOptions.min),this.selection=new t.SelectionHighlight(this.game,this.inputOptions),this.addChild(this.selection),h.placeHolder&&h.placeHolder.length>0&&(this.placeHolder=new Phaser.Text(n,this.inputOptions.padding,this.inputOptions.padding,h.placeHolder,{font:h.font||"14px Arial",fontWeight:h.fontWeight||"normal",fill:h.placeHolderColor||"#bfbebd"}),this.placeHolder.mask=this.textMask,this.addChild(this.placeHolder)),this.cursor=new Phaser.Text(n,this.inputOptions.padding,this.inputOptions.padding-2,"|",{font:h.font||"14px Arial",fontWeight:h.fontWeight||"normal",fill:h.cursorColor||"#000000"}),this.cursor.visible=!1,this.addChild(this.cursor),this.text=new Phaser.Text(n,this.inputOptions.padding,this.inputOptions.padding,"",{font:h.font||"14px Arial",fontWeight:h.fontWeight||"normal",fill:h.fill||"#000000"}),this.text.mask=this.textMask,this.addChild(this.text),this.offscreenText=new Phaser.Text(n,this.inputOptions.padding,this.inputOptions.padding,"",{font:h.font||"14px Arial",fontWeight:h.fontWeight||"normal",fill:h.fill||"#000000"}),this.inputOptions.textAlign){case"left":this.text.anchor.set(0,0),this.cursor.x=this.inputOptions.padding+this.getCaretPosition();break;case"center":this.text.anchor.set(.5,0),this.text.x+=this.inputOptions.width/2,this.cursor.x=this.inputOptions.padding+this.inputOptions.width/2-this.text.width/2+this.getCaretPosition();break;case"right":this.text.anchor.set(1,0),this.text.x+=this.inputOptions.width,this.cursor.x=this.inputOptions.padding+this.inputOptions.width}this.inputEnabled=!0,this.input.useHandCursor=!0,this.game.input.onDown.add(this.checkDown,this),this.domElement.focusOut.add(function(){t.Plugins.InputField.KeyboardOpen&&(y.endFocus(),y.inputOptions.zoom&&y.zoomOut())})}return K(s,a),s.prototype.checkDown=function(n){if(this.value||this.resetText(),this.input.checkPointerOver(n)){if(this.focus)return void this.setCaretOnclick(n);this.inputOptions.zoom&&!t.Plugins.InputField.Zoomed&&this.zoomIn(),this.startFocus()}else this.focus===!0&&(this.endFocus(),this.inputOptions.zoom&&this.zoomOut())},s.prototype.update=function(){if(this.focus){if(this.cnt!==30)return this.cnt++;this.cursor.visible=this.blink,this.blink=!this.blink,this.cnt=0}},s.prototype.endFocus=function(){var n=this;this.domElement.removeEventListener(),this.blockInput===!0&&this.domElement.unblockKeyDownEvents(),this.focus=!1,this.value.length===0&&this.placeHolder!==null&&(this.placeHolder.visible=!0),this.cursor.visible=!1,this.game.device.desktop?setTimeout(function(){n.domElement.blur()},0):this.domElement.blur(),this.game.device.desktop||(t.Plugins.InputField.KeyboardOpen=!1,t.Plugins.InputField.onKeyboardClose.dispatch())},s.prototype.startFocus=function(){var n=this;this.focus=!0,this.placeHolder!==null&&(this.placeHolder.visible=!1),this.game.device.desktop?setTimeout(function(){n.keyUpProcessor()},0):this.keyUpProcessor(),this.game.device.desktop||(t.Plugins.InputField.KeyboardOpen=!0,t.Plugins.InputField.onKeyboardOpen.dispatch())},s.prototype.keyUpProcessor=function(){this.domElement.addKeyUpListener(this.keyListener.bind(this)),this.domElement.focus(),this.blockInput===!0&&this.domElement.blockKeyDownEvents()},s.prototype.updateText=function(){var n="";if(this.inputOptions.type===t.InputType.password)for(var r=0;r<this.value.length;r++)n+="*";else if(this.inputOptions.type===t.InputType.number){var c=parseInt(this.value);n=c<parseInt(this.inputOptions.min)?this.value=this.domElement.value=this.inputOptions.min:c>parseInt(this.inputOptions.max)?this.value=this.domElement.value=this.inputOptions.max:this.value}else n=this.value;if(this.text.setText(n),this.text.width>this.inputOptions.width)this.text.anchor.x=1,this.text.x=this.inputOptions.padding+this.inputOptions.width;else switch(this.inputOptions.textAlign){case"left":this.text.anchor.set(0,0),this.text.x=this.inputOptions.padding;break;case"center":this.text.anchor.set(.5,0),this.text.x=this.inputOptions.padding+this.inputOptions.width/2;break;case"right":this.text.anchor.set(1,0),this.text.x=this.inputOptions.padding+this.inputOptions.width}},s.prototype.updateCursor=function(){if(this.text.width>this.inputOptions.width||this.inputOptions.textAlign==="right")this.cursor.x=this.inputOptions.padding+this.inputOptions.width;else switch(this.inputOptions.textAlign){case"left":this.cursor.x=this.inputOptions.padding+this.getCaretPosition();break;case"center":this.cursor.x=this.inputOptions.padding+this.inputOptions.width/2-this.text.width/2+this.getCaretPosition()}},s.prototype.getCaretPosition=function(){var n=this.domElement.getCaretPosition();if(n===-1)return this.text.width;var r=this.value;if(this.inputOptions.type===t.InputType.password){r="";for(var c=0;c<this.value.length;c++)r+="*"}return this.offscreenText.setText(r.slice(0,n)),this.offscreenText.width},s.prototype.setCaretOnclick=function(n){var r=this.text.toLocal(new PIXI.Point(n.x,n.y),this.game.world).x;this.inputOptions.textAlign&&this.inputOptions.textAlign==="center"&&(r+=this.text.width/2);for(var c=this.text.width/this.value.length,h=0,y=0;y<this.value.length;y++)if(r>=y*c&&(y+1)*c>=r){h=y;break}r>(this.value.length-1)*c&&(h=this.value.length),this.startFocus(),this.domElement.setCaretPosition(h),this.updateCursor()},s.prototype.updateSelection=function(){if(this.domElement.hasSelection){var n=this.value;if(this.inputOptions.type===t.InputType.password){n="";for(var r=0;r<this.value.length;r++)n+="*"}switch(n=n.substring(this.domElement.caretStart,this.domElement.caretEnd),this.offscreenText.setText(n),this.selection.updateSelection(this.offscreenText.getBounds()),this.inputOptions.textAlign){case"left":this.selection.x=this.inputOptions.padding;break;case"center":this.selection.x=this.inputOptions.padding+this.inputOptions.width/2-this.text.width/2}}else this.selection.clear()},s.prototype.zoomIn=function(){if(!t.Plugins.InputField.Zoomed){var n=this.getBounds();window.innerHeight>window.innerWidth?this.windowScale=this.game.width/(1.5*n.width):this.windowScale=this.game.width/2/(1.5*n.width);var r=(this.game.width-1.5*n.width)/2/this.windowScale;this.game.world.scale.set(this.game.world.scale.x*this.windowScale,this.game.world.scale.y*this.windowScale),this.game.world.pivot.set(n.x-r,n.y-2*this.inputOptions.padding),t.Plugins.InputField.Zoomed=!0}},s.prototype.zoomOut=function(){t.Plugins.InputField.Zoomed&&(this.game.world.scale.set(this.game.world.scale.x/this.windowScale,this.game.world.scale.y/this.windowScale),this.game.world.pivot.set(0,0),t.Plugins.InputField.Zoomed=!1)},s.prototype.keyListener=function(n){return this.value=this.domElement.value,n.keyCode===13?void(this.focusOutOnEnter&&this.endFocus()):(this.updateText(),this.updateCursor(),this.updateSelection(),void n.preventDefault())},s.prototype.destroy=function(n){this.game.input.onDown.remove(this.checkDown,this),this.domElement.focusIn.removeAll(),this.domElement.focusOut.removeAll(),this.domElement.destroy(),a.prototype.destroy.call(this,n)},s.prototype.resetText=function(){this.setText()},s.prototype.setText=function(n){n===void 0&&(n=""),this.placeHolder!==null&&(n.length>0?this.placeHolder.visible=!1:this.placeHolder.visible=!0),this.value=n,this.domElement.value=this.value,this.updateText(),this.updateCursor(),this.endFocus()},s}(Phaser.Sprite);t.InputField=i})(B||(B={}));var B;(function(t){var i=function(a){function s(n,r){a.call(this,n,0,0);var c=r.backgroundColor?parseInt(r.backgroundColor.slice(1),16):16777215,h=r.borderRadius||0,y=r.borderColor?parseInt(r.borderColor.slice(1),16):9803157,g=r.fillAlpha,w=r.height;r.font&&(w=Math.max(parseInt(r.font.substr(0,r.font.indexOf("px")),10),w)),w=2*r.padding+w;var b=r.width;b=2*r.padding+b,this.beginFill(c,g).lineStyle(r.borderWidth||1,y,g),h>0?this.drawRoundedRect(0,0,b,w,h):this.drawRect(0,0,b,w)}return K(s,a),s}(Phaser.Graphics);t.InputBox=i})(B||(B={}));var B;(function(t){var i=function(a){function s(n,r){a.call(this,n,r.padding,r.padding),this.inputOptions=r}return K(s,a),s.prototype.updateSelection=function(n){var r=Phaser.Color.webToColor(this.inputOptions.selectionColor);this.clear(),this.beginFill(s.rgb2hex(r),r.a),this.drawRect(n.x,n.y,n.width,n.height-this.inputOptions.padding)},s.rgb2hex=function(n){return parseInt(("0"+n.r.toString(16)).slice(-2)+("0"+n.g.toString(16)).slice(-2)+("0"+n.b.toString(16)).slice(-2),16)},s}(Phaser.Graphics);t.SelectionHighlight=i})(B||(B={}));var B;(function(t){var i=function(a){function s(n,r){a.call(this,n,r.padding,r.padding);var c=r.borderRadius,h=r.height;r.font&&(h=Math.max(parseInt(r.font.substr(0,r.font.indexOf("px")),10),h));var y=r.width;this.beginFill(0),c>0?this.drawRoundedRect(0,0,y,h,c):this.drawRect(0,0,y,h)}return K(s,a),s}(Phaser.Graphics);t.TextMask=i})(B||(B={}));var B;(function(t){(function(i){var a=function(s){function n(r,c){s.call(this,r,c),this.addInputFieldFactory()}return K(n,s),n.prototype.addInputFieldFactory=function(){Phaser.GameObjectFactory.prototype.inputField=function(r,c,h,y){y===void 0&&(y=this.world);var g=new t.InputField(this.game,r,c,h);return y.add(g)},Phaser.GameObjectCreator.prototype.inputField=function(r,c,h){return new t.InputField(this.game,r,c,h)}},n.Zoomed=!1,n.KeyboardOpen=!1,n.onKeyboardOpen=new Phaser.Signal,n.onKeyboardClose=new Phaser.Signal,n}(Phaser.Plugin);i.InputField=a})(t.Plugins||(t.Plugins={}))})(B||(B={}));window.Fabrique=B;function _(t,i,a){Human.call(this,t,i,a),this.anchor.set(.25,.35),this.orientation=4,this.speed=Game.playerSpeed,this.dialoguesMemory={},this.maxLife=Game.playerLife,this.life=this.maxLife,this.inFight=!1,this.defaultFrames={attack_right:[0,4,9],right:[5,8],idle_right:[9,10],attack_up:[11,15,20],up:[16,19],idle_up:[20,21],attack_down:[22,26,31],down:[27,30],idle_down:[31,32],attack_left:[33,37,42],left:[38,41],idle_left:[42,43]},this.addChild(this.weapon=game.add.sprite(0,0,"atlas3")),this.addChild(this.shadow=game.add.sprite(0,5,"atlas1","shadow")),this.addChild(this.nameHolder=game.add.text(0,-30,"",{font:"14px pixel",fill:"#ffffff",stroke:"#000000",strokeThickness:2})),this.events.onKilled.add(function(s){Game.displayedPlayers.delete(s.id)},this)}window.Player=_;_.prototype=Object.create(Human.prototype);_.prototype.constructor=_;_.prototype.setIsPlayer=function(t){this.isPlayer=t,this.isPlayer&&this.nameHolder.addColor("#f4d442",0)};_.prototype.setName=function(t){this.nameHolder.text=t,this.nameHolder.x=Math.floor(16-this.nameHolder.width/2)};_.prototype.prepareMovement=function(t,i,a,s,n){if(this.alive&&t){var r=Game.computeTileCoords(this.x,this.y);if(r.x==t.x&&r.y==t.y){a.action==1&&this.finishMovement(i,a);return}this.isPlayer&&Game.manageMoveTarget(t.x,t.y),this.tween&&(this.stopMovement(!1),r=this.adjustStartPosition(r)),this.isPlayer&&this.inFight&&a.action!=3&&this.endFight(),Game.easystar.findPath(r.x,r.y,t.x,t.y,this.pathfindingCallback.bind(this,i,a,s,n)),Game.easystar.calculate()}};_.prototype.equipWeapon=function(t){return this.weapon.name=t,this.weapon.frameName=t+"_0",this.weapon.absorbProperties(Game.itemsInfo[t]),this.atk=this.weapon.atk,this.adjustWeapon(),this.setAnimations(this.weapon),this.isPlayer&&(Game.weaponIcon.frameName=this.weapon.icon+"_0",Client.setWeapon(t)),!0};_.prototype.adjustWeapon=function(){this.weapon.position.set(this.weapon.offsets.x,this.weapon.offsets.y)};_.prototype.equipArmor=function(t){var i=Game.itemsInfo[t];this.def=i.def,this.armorName=t,this.frameName=t+"_0",this.isPlayer&&(Game.armorIcon.frameName=i.icon+"_0",Client.setArmor(t),Game.armorIcon.anchor.set(0,0),i.iconAnchor&&Game.armorIcon.anchor.set(i.iconAnchor.x,i.iconAnchor.y));var a=i.hasOwnProperty("frames")?i.frames:null;return this.frames=a,this.setAnimations(this),!0};_.prototype.updateLife=function(){this.life<0&&(this.life=0);var t=Game.computeLifeBarWidth(),i=game.add.tween(Game.health.getChildAt(0)),a=game.add.tween(Game.health.getChildAt(1));i.to({width:t},200,null,!1,200),a.to({x:t},200,null,!1,200),i.start(),a.start()};_.prototype.teleport=function(){var t=Game.computeTileCoords(this.x,this.y),i=Game.doors.getFirst(t.x,t.y);if(i){this.position.set(i.to.x,i.to.y),this.isPlayer&&(i.camera&&!i.follow?(Game.unfollowPlayer(),game.camera.x=i.camera.x,game.camera.y=i.camera.y):i.follow?Game.followPlayerIndoors(i.min_cx,i.min_cy,i.max_cx,i.max_cy):Game.followPlayer());var a={l:1,u:2,r:3,d:4};return a[i.orientation]}return null};_.prototype.fight=function(){this.target&&(this.inFight=!0,this.fightTween=game.add.tween(this),this.fightTween.to({},Phaser.Timer.SECOND,null,!1,0,-1),this.fightTween.onStart.add(function(){this.fightAction()},this),this.fightTween.onLoop.add(function(){this.fightAction()},this),this.fightTween.start())};_.prototype.fightAction=function(){if(!this.isPlayer){var t=Game.adjacent(this,this.target);t>0&&(this.tween&&(this.tween.stop(),this.tween=null),this.orientation=t,this.attack())}};_.prototype.die=function(t){this.tween&&this.stopMovement(!1),this.endFight(),this.target=null,this.life=0,this.isPlayer&&(Game.moveTarget.visible=!1,this.updateLife(),setTimeout(Game.displayDeathScroll,Phaser.Timer.SECOND*2)),t&&this.inCamera&&(this.frameName="death_0",this.animate("death",!1),Game.sounds.play("death")),this.delayedKill(750)};_.prototype.respawn=function(){this.revive(),this.orientation=game.rnd.between(1,4),this.isPlayer&&(this.life=this.maxLife,this.updateLife()),this.idle(!0)};
